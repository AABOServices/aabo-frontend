<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectHub - Control Documental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
        }
        :root {
            --halli-red: #DA291C;
            --halli-dark-gray: #1E1E1E;
            --halli-medium-gray: #58595b;
            --halli-light-gray: #e6e7e8;
        }
        .halli-red-text { color: var(--halli-red); }
        .halli-red-bg { background-color: var(--halli-red); }
        .halli-dark-text { color: var(--halli-dark-gray); }
        .halli-medium-text { color: var(--halli-medium-gray); }
        .halli-light-border { border-color: var(--halli-light-gray); }
        
        .progress-bar-bg { background-color: var(--halli-light-gray); }
        .progress-bar-fill-high { background-color: #28a745; }
        .progress-bar-fill-medium { background-color: #fd7e14; }
        .progress-bar-fill-low { background-color: var(--halli-red); }

        .status-tag {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status-aprobado { background-color: #dcfce7; color: #166534; }
        .status-aprobado-comentarios { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .status-comentado { background-color: #fed7aa; color: #9a3412; }
        .status-rechazado { background-color: #fee2e2; color: #991b1b; }
        .status-aprobado-construccion { background-color: #bbf7d0; color: #14532d; font-weight: bold; border: 2px solid #22c55e; }
        .status-enviado-cdd { background-color: #dbeafe; color: #1e40af; }
        .status-emitido-revision { background-color: #e9d5ff; color: #6b21a8; }
        .status-en-revision { background-color: #c7d2fe; color: #3730a3; }
        .status-en-elaboracion { background-color: #f3f4f6; color: #374151; }
        .status-para-aprobacion { background-color: #e0e7ff; color: #3730a3; }
        .status-para-revision-cliente { background-color: #fef9c3; color: #854d0e; }
        .status-revision-interna { background-color: #e5e7eb; color: #4b5563; }
        .status-aprobado-internamente { background-color: #cffafe; color: #0e7490; }
        
        .nav-link.active {
            background-color: var(--halli-red);
            color: white;
        }
        .nav-link:not(.active) {
            color: #374151;
        }
        .nav-link:not(.active):hover {
            background-color: #f3f4f6;
        }

        .tab-btn.active {
            border-color: var(--halli-red);
            color: var(--halli-red);
        }
        
        .filter-btn.active {
            background-color: var(--halli-red);
            color: white;
        }

        .modal {
            transition: opacity 0.25s ease;
        }

        /* Notifications Styles */
        .notification-item {
            transition: all 0.15s ease;
        }
        .notification-item:hover {
            transform: translateX(2px);
        }
        .notification-item.unread {
            background: linear-gradient(90deg, rgba(59,130,246,0.05) 0%, transparent 100%);
            border-left: 3px solid #3b82f6;
        }
        .notification-search-input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .notification-search-input:focus {
            outline: none;
            border-color: #DA291C;
            box-shadow: 0 0 0 3px rgba(218, 41, 28, 0.1);
        }
        .notification-filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .notification-filter-select:focus {
            outline: none;
            border-color: #DA291C;
            box-shadow: 0 0 0 3px rgba(218, 41, 28, 0.1);
        }
        .notification-action-button {
            transition: all 0.2s ease;
        }
        .notification-action-button:hover {
            transform: translateY(-1px);
        }
        .notification-stats-card {
            transition: all 0.2s ease;
        }
        .notification-stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .notification-empty-state {
            padding: 4rem 2rem;
            text-align: center;
        }
        
        /* Prevent horizontal overflow in notifications */
        #notification-dropdown {
            max-width: 320px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        #notification-dropdown .notification-item {
            overflow: hidden;
        }
        
        #notification-dropdown .notification-item p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        #notification-dropdown .notification-item .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #notification-dropdown .flex-1 {
            min-width: 0;
        }
        
        /* Accordion Styles */
        .accordion-header {
            border-bottom: 1px solid #e5e7eb;
        }
        .accordion-content {
            transition: all 0.3s ease;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="flex h-screen bg-white">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg flex flex-col flex-shrink-0">
            <div class="border-b halli-light-border p-4">
                <h1 class="text-2xl font-bold halli-dark-text">ProjectHub</h1>
                <p class="text-sm halli-medium-text">Control Documental</p>
            </div>
            <nav id="main-nav" class="flex-grow p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    Dashboard
                </a>
                <a href="#repository" class="nav-link flex items-center px-4 py-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
                    Repositorio
                </a>
                 <a href="#transmittals" class="nav-link flex items-center px-4 py-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v4a1 1 0 001 1h12a1 1 0 001-1v-4a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM8 18c0 1.105.895 2 2 2s2-.895 2-2H8z" /></svg>
                    Transmittals
                </a>
                <a href="#reports" class="nav-link flex items-center px-4 py-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Reportes
                </a>
                <a href="#notifications" class="nav-link flex items-center px-4 py-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    Notificaciones
                </a>
                <a href="#settings" class="nav-link flex items-center px-4 py-2 rounded-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Configuración
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-8 overflow-y-auto bg-gray-50">
            <div class="max-w-7xl mx-auto">
                 <!-- Header Superior -->
                <header class="flex justify-between items-center mb-6">
                    <div class="relative w-full max-w-lg">
                        <input type="text" id="projectSearch" placeholder="Buscar por proyecto, documento..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button id="notification-bell" class="relative text-gray-500 hover:text-gray-800 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                                <span id="notification-badge" class="absolute -top-1 -right-1 flex h-3 w-3 hidden">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 halli-red-bg"></span>
                                </span>
                                <span id="notification-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold hidden">0</span>
                            </button>
                            
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 max-w-[calc(100vw-2rem)] bg-white rounded-lg shadow-lg border border-gray-200 hidden z-50">
                                <div class="p-4 border-b border-gray-200">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-lg font-semibold text-gray-900">Notificaciones</h3>
                                        <button id="mark-all-read-dropdown" class="text-sm text-red-600 hover:text-red-800">Marcar todas como leídas</button>
                                    </div>
                                </div>
                                <div id="notification-list" class="max-h-96 overflow-y-auto">
                                    <!-- Sample notifications - will be populated by JavaScript -->
                                    <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-blue-50" data-notification-id="1">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0 mt-1">
                                                <div class="text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <p class="text-sm font-semibold text-gray-900 truncate flex-1 min-w-0">Documento Aprobado</p>
                                                    <span class="text-xs text-gray-500 ml-2 flex-shrink-0">15 ene</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1 break-words">El documento PA-PRO-PID-001 ha sido aprobado por el cliente</p>
                                                <div class="flex items-center mt-2 flex-wrap gap-1">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 truncate max-w-full">Palo Azul - Fase II</span>
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 truncate max-w-full">PA-PRO-PID-001</span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-blue-50" data-notification-id="2">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0 mt-1">
                                                <div class="text-yellow-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg></div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <p class="text-sm font-semibold text-gray-900 truncate flex-1 min-w-0">Documento Requiere Revisión</p>
                                                    <span class="text-xs text-gray-500 ml-2 flex-shrink-0">15 ene</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1 break-words">El documento B57SH23001-SCP-02-001 necesita revisión interna</p>
                                                <div class="flex items-center mt-2 flex-wrap gap-1">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 truncate max-w-full">Bombas de Reinyección de Agua</span>
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 truncate max-w-full">B57SH23001-SCP-02-001</span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-blue-50" data-notification-id="3">
                                        <div class="flex items-start space-x-3">
                                            <div class="flex-shrink-0 mt-1">
                                                <div class="text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg></div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between">
                                                    <p class="text-sm font-semibold text-gray-900 truncate flex-1 min-w-0">Transmittal Recibido</p>
                                                    <span class="text-xs text-gray-500 ml-2 flex-shrink-0">15 ene</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1 break-words">Se recibió el transmittal SUB-A-TR-005 de Subcontratista A</p>
                                                <div class="flex items-center mt-2 flex-wrap gap-1">
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 truncate max-w-full">Palo Azul - Fase II</span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 border-t border-gray-200 text-center">
                                    <button id="view-all-notifications" class="text-sm text-gray-600 hover:text-gray-800">Ver todas las notificaciones</button>
                                </div>
                            </div>
                        </div>
                        <div id="user-profile-trigger" class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-2 rounded-lg transition-colors">
                             <img class="h-8 w-8 rounded-full object-cover" src="https://placehold.co/100x100/e2e8f0/64748b?text=CR" alt="User profile">
                            <div>
                                <p class="font-semibold text-sm">C. Rodriguez</p>
                                <p class="text-xs text-gray-500">Gerente de Proyecto</p>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- Vistas de la Aplicación -->
                <div id="app-views">
                    <!-- Vista Dashboard -->
                    <div id="dashboard-view" class="app-view">
                         <div id="dashboard-header" class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <div>
                                <h2 class="text-3xl font-bold halli-dark-text">Proyectos</h2>
                                <div id="project-filters" class="flex items-center space-x-2 mt-2">
                                     <button data-status="En Ejecución" class="filter-btn active px-3 py-1 text-sm font-medium text-white halli-red-bg rounded-full">En Ejecución</button>
                                     <button data-status="Completado" class="filter-btn px-3 py-1 text-sm font-medium text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-full">Completado</button>
                                     <button data-status="En Pausa" class="filter-btn px-3 py-1 text-sm font-medium text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-full">En Pausa</button>
                                </div>
                            </div>
                        </div>
                        <div id="project-cards-container"></div>
                        <div id="dashboard-content" class="hidden"></div>
                    </div>

                    <!-- Vista Repositorio -->
                     <div id="repository-view" class="app-view hidden">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-3xl font-bold halli-dark-text">Repositorio Documental</h2>
                             <div class="flex space-x-2">
                                 <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border rounded-lg shadow-sm hover:bg-gray-50">Exportar a Excel</button>
                                 <button id="upload-doc-btn" class="px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-lg shadow-sm hover:opacity-90">Cargar Documento</button>
                             </div>
                        </div>
                        <div id="repository-content"></div>
                    </div>

                    <!-- Vista Transmittals -->
                    <div id="transmittals-view" class="app-view hidden">
                        <div class="flex justify-between items-center mb-6">
                             <h2 class="text-3xl font-bold halli-dark-text">Transmittals</h2>
                             <button id="create-transmittal-btn" class="px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-lg shadow-sm hover:opacity-90">Crear Transmittal</button>
                        </div>
                        <div id="transmittals-content"></div>
                    </div>
                    
                     <div id="reports-view" class="app-view hidden">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-3xl font-bold halli-dark-text">Reportes y Analítica</h2>
                         </div>
                         <div id="reports-content"></div>
                     </div>
                     
                     <div id="notifications-view" class="app-view hidden">
                         <div class="flex justify-between items-center mb-6">
                             <div>
                                 <h2 class="text-3xl font-bold halli-dark-text">Notificaciones</h2>
                                 <p class="text-sm halli-medium-text mt-1">Gestiona todas tus notificaciones del sistema</p>
                             </div>
                             <div class="flex items-center space-x-4">
                                 <button id="mark-all-read-btn" class="notification-action-button px-6 py-3 text-sm font-semibold text-white halli-red-bg rounded-xl shadow-lg hover:shadow-xl hover:opacity-95 transition-all duration-200">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                     </svg>
                                     Marcar todas como leídas
                                 </button>
                                 <button id="refresh-notifications-btn" class="notification-action-button px-6 py-3 text-sm font-semibold text-gray-700 bg-white border-2 border-gray-200 rounded-xl shadow-sm hover:bg-gray-50 hover:border-gray-300 transition-all duration-200">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                     </svg>
                                     Actualizar
                                 </button>
                             </div>
                         </div>

                         <!-- Enhanced Filters and Search -->
                         <div class="notification-filter-section">
                             <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                                 <div>
                                     <label class="block text-sm font-semibold text-gray-700 mb-3">Buscar Notificaciones</label>
                                     <div class="relative">
                                         <input type="text" id="search-notifications" placeholder="Buscar en notificaciones..." class="notification-search-input w-full">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                             <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                         </svg>
                                     </div>
                                 </div>
                                 <div>
                                     <label class="block text-sm font-semibold text-gray-700 mb-3">Estado</label>
                                     <select id="status-filter" class="notification-filter-select w-full">
                                         <option value="all">Todas las notificaciones</option>
                                         <option value="unread">No leídas</option>
                                         <option value="read">Leídas</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label class="block text-sm font-semibold text-gray-700 mb-3">Tipo de Notificación</label>
                                     <select id="type-filter" class="notification-filter-select w-full">
                                         <option value="all">Todos los tipos</option>
                                         <option value="document_approval">Aprobación de Documentos</option>
                                         <option value="document_revision">Revisión de Documentos</option>
                                         <option value="transmittal_received">Transmittals Recibidos</option>
                                         <option value="deadline_approaching">Fechas Límite</option>
                                         <option value="document_rejected">Documentos Rechazados</option>
                                         <option value="new_document">Nuevos Documentos</option>
                                         <option value="project_update">Actualizaciones de Proyecto</option>
                                         <option value="comment_added">Comentarios</option>
                                     </select>
                                 </div>
                                 <div>
                                     <label class="block text-sm font-semibold text-gray-700 mb-3">Proyecto</label>
                                     <select id="project-filter" class="notification-filter-select w-full">
                                         <option value="all">Todos los proyectos</option>
                                         <option value="proj-001">Palo Azul - Fase II</option>
                                         <option value="proj-004">Bombas de Reinyección de Agua</option>
                                     </select>
                                 </div>
                             </div>
                         </div>

                         <!-- Enhanced Statistics -->
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                             <div class="notification-stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                 <div class="flex items-center">
                                     <div class="p-3 bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                         </svg>
                                     </div>
                                     <div class="ml-4">
                                         <p class="text-sm font-semibold text-gray-600 mb-1">Total</p>
                                         <p class="text-3xl font-bold text-gray-900" id="total-notifications">0</p>
                                     </div>
                                 </div>
                             </div>
                             <div class="notification-stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                 <div class="flex items-center">
                                     <div class="p-3 bg-gradient-to-br from-red-100 to-red-200 rounded-xl">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                         </svg>
                                     </div>
                                     <div class="ml-4">
                                         <p class="text-sm font-semibold text-gray-600 mb-1">No leídas</p>
                                         <p class="text-3xl font-bold text-gray-900" id="unread-notifications">0</p>
                                     </div>
                                 </div>
                             </div>
                             <div class="notification-stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                 <div class="flex items-center">
                                     <div class="p-3 bg-gradient-to-br from-green-100 to-green-200 rounded-xl">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                         </svg>
                                     </div>
                                     <div class="ml-4">
                                         <p class="text-sm font-semibold text-gray-600 mb-1">Leídas</p>
                                         <p class="text-3xl font-bold text-gray-900" id="read-notifications">0</p>
                                     </div>
                                 </div>
                             </div>
                             <div class="notification-stats-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                 <div class="flex items-center">
                                     <div class="p-3 bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl">
                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                         </svg>
                                     </div>
                                     <div class="ml-4">
                                         <p class="text-sm font-semibold text-gray-600 mb-1">Hoy</p>
                                         <p class="text-3xl font-bold text-gray-900" id="today-notifications">0</p>
                                     </div>
                                 </div>
                             </div>
                         </div>

                         <!-- Enhanced Notifications List -->
                         <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                             <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
                                 <div class="flex justify-between items-center">
                                     <div>
                                         <h3 class="text-xl font-bold text-gray-900 mb-1">Lista de Notificaciones</h3>
                                         <p class="text-sm text-gray-600">Gestiona y revisa todas tus notificaciones del sistema</p>
                                     </div>
                                     <div class="flex items-center space-x-3 bg-white px-4 py-2 rounded-lg border border-gray-200">
                                         <span class="text-sm text-gray-500">Mostrando</span>
                                         <span id="showing-count" class="text-sm font-semibold text-gray-900">0</span>
                                         <span class="text-sm text-gray-500">de</span>
                                         <span id="total-count" class="text-sm font-semibold text-gray-900">0</span>
                                         <span class="text-sm text-gray-500">notificaciones</span>
                                     </div>
                                 </div>
                             </div>
                             <div id="notifications-container" class="divide-y divide-gray-100">
                                 <!-- Notifications will be populated by JavaScript -->
                             </div>
                             <div id="no-notifications" class="notification-empty-state hidden">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-300 mx-auto mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                 </svg>
                                 <h3 class="text-xl font-semibold text-gray-700 mb-3">No hay notificaciones</h3>
                                 <p class="text-gray-500 max-w-md mx-auto">No se encontraron notificaciones que coincidan con los filtros seleccionados. Intenta ajustar los criterios de búsqueda.</p>
                             </div>
                         </div>

                         <!-- Enhanced Pagination -->
                         <div class="notification-pagination">
                             <nav class="flex items-center space-x-3">
                                 <button id="prev-page" class="notification-action-button px-4 py-2 text-sm font-semibold text-gray-600 bg-white border-2 border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                     </svg>
                                     Anterior
                                 </button>
                                 <div id="page-numbers" class="flex space-x-2">
                                     <!-- Page numbers will be populated by JavaScript -->
                                 </div>
                                 <button id="next-page" class="notification-action-button px-4 py-2 text-sm font-semibold text-gray-600 bg-white border-2 border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                                     Siguiente
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                     </svg>
                                 </button>
                             </nav>
                         </div>
                     </div>
                     
                     <div id="settings-view" class="app-view hidden">
                         <div class="flex justify-between items-center mb-6">
                             <h2 class="text-3xl font-bold halli-dark-text">Administración y Configuración</h2>
                         </div>
                         <div id="settings-content"></div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>
    
    <div id="transmittal-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all">
             <!-- Contenido del modal se renderizará aquí -->
        </div>
    </div>
    
    <div id="upload-doc-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] transform transition-all flex flex-col">
            <div class="p-6 border-b flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Asistente de Carga de Documento</h3>
                    <button onclick="closeUploadDocModal()" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="upload-doc-form" class="space-y-4">
                    <!-- Code Generator Section -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 mb-3">Generador de Código PETROECUADOR</h4>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="upload-project" class="block text-xs font-medium text-gray-700 mb-1">Proyecto *</label>
                                <input type="text" id="upload-project" name="project" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="B18PA003A" onchange="checkAndAutoGenerateUpload()">
                            </div>

                            <div>
                                <label for="upload-location" class="block text-xs font-medium text-gray-700 mb-1">Locación *</label>
                                <input type="text" id="upload-location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="ZPF" onchange="checkAndAutoGenerateUpload()">
                            </div>
                        </div>

                        <!-- Disciplina -->
                        <div class="mt-3">
                            <label for="upload-discipline" class="block text-xs font-medium text-gray-700 mb-1">Disciplina *</label>
                            <select id="upload-discipline" name="discipline" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="onDisciplineChangeUpload()">
                                <option value="">Seleccionar disciplina...</option>
                                <option value="Procesos">Procesos</option>
                                <option value="Mecánica">Mecánica</option>
                                <option value="Civil">Civil</option>
                                <option value="Tubería">Tubería</option>
                                <option value="Instrumentación">Instrumentación</option>
                                <option value="Eléctrica">Eléctrica</option>
                                <option value="Comunicaciones">Comunicaciones</option>
                                <option value="Skid">Skid</option>
                                <option value="Protección Catódica">Protección Catódica</option>
                                <option value="Gestión">Gestión</option>
                            </select>
                        </div>

                        <!-- Tipo de Plano -->
                        <div class="mt-3">
                            <label for="upload-discipline-type" class="block text-xs font-medium text-gray-700 mb-1">Tipo de Plano *</label>
                            <select id="upload-discipline-type" name="discipline_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="checkAndAutoGenerateUpload()" disabled>
                                <option value="">Seleccionar tipo de plano...</option>
                            </select>
                        </div>

                        <div class="mt-3">
                            <label for="upload-sequence" class="block text-xs font-medium text-gray-700 mb-1">Número de Secuencia</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="upload-sequence" name="sequence" min="1" max="999" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="generateDocumentCodeUpload()">
                                <button type="button" onclick="generateDocumentCodeUpload()" class="px-3 py-2 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition-colors">
                                    Generar
                                </button>
                                <button type="button" onclick="autoGenerateCodeUpload()" class="px-3 py-2 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-colors">
                                    Auto
                                </button>
                            </div>
                        </div>

                        <div class="mt-3 p-3 bg-white rounded border">
                            <label for="upload-code" class="block text-xs font-medium text-gray-700 mb-1">Código Generado *</label>
                            <input type="text" id="upload-code" name="code" required readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-mono" placeholder="B18PA003A-SHY-ZPF-70-001-A">
                        </div>
                    </div>

                    <div>
                        <label for="upload-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Documento *</label>
                        <input type="text" id="upload-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Diagrama Unifilar Principal">
                    </div>

                    <div>
                        <label for="upload-responsible" class="block text-sm font-medium text-gray-700 mb-1">Responsable *</label>
                        <input type="text" id="upload-responsible" name="responsible" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="A. Vargas">
                    </div>

                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Valores por Defecto:</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <p><strong>Revisión:</strong> A</p>
                            <p><strong>Estado:</strong> En Elaboración</p>
                            <p><strong>Costo:</strong> $0</p>
                            <p><strong>Fechas:</strong> Sin especificar</p>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeUploadDocModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Cargar y Registrar
                        </button>
                    </div>
            </form>
            </div>
        </div>
    </div>

    <div id="document-details-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] transform transition-all flex flex-col">
            <div class="p-6 border-b flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Detalles del Documento</h3>
                    <button class="close-modal-btn text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="document-details-content" class="p-6 overflow-y-auto flex-1">
                <!-- Document details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Add Document Modal -->
    <div id="add-document-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] transform transition-all flex flex-col">
            <div class="p-6 border-b flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Añadir Nuevo Documento</h3>
                    <button onclick="closeAddDocumentModal()" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <form id="add-document-form" class="space-y-4">
                    <!-- Code Generator Section -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-sm font-medium text-blue-800 mb-3">Generador de Código PETROECUADOR</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label for="doc-project" class="block text-xs font-medium text-gray-700 mb-1">Proyecto *</label>
                                <input type="text" id="doc-project" name="project" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="B18PA003A" onchange="checkAndAutoGenerate()">
                            </div>
                            
                            <div>
                                <label for="doc-location" class="block text-xs font-medium text-gray-700 mb-1">Locación *</label>
                                <input type="text" id="doc-location" name="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" placeholder="ZPF" onchange="checkAndAutoGenerate()">
                            </div>
                        </div>
                        
                        <!-- Disciplina -->
                        <div class="mt-3">
                            <label for="doc-discipline" class="block text-xs font-medium text-gray-700 mb-1">Disciplina *</label>
                            <select id="doc-discipline" name="discipline" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="onDisciplineChange()">
                                <option value="">Seleccionar disciplina...</option>
                                <option value="Procesos">Procesos</option>
                                <option value="Mecánica">Mecánica</option>
                                <option value="Civil">Civil</option>
                                <option value="Tubería">Tubería</option>
                                <option value="Instrumentación">Instrumentación</option>
                                <option value="Eléctrica">Eléctrica</option>
                                <option value="Comunicaciones">Comunicaciones</option>
                                <option value="Skid">Skid</option>
                                <option value="Protección Catódica">Protección Catódica</option>
                                <option value="Gestión">Gestión</option>
                            </select>
                        </div>

                        <!-- Tipo de Plano -->
                        <div class="mt-3">
                            <label for="doc-discipline-type" class="block text-xs font-medium text-gray-700 mb-1">Tipo de Plano *</label>
                            <select id="doc-discipline-type" name="discipline_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="checkAndAutoGenerate()" disabled>
                                <option value="">Seleccionar tipo de plano...</option>
                            </select>
                        </div>
                        
                        <div class="mt-3">
                            <label for="doc-sequence" class="block text-xs font-medium text-gray-700 mb-1">Número de Secuencia</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="doc-sequence" name="sequence" min="1" max="999" value="1" class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="generateDocumentCode()">
                                <button type="button" onclick="generateDocumentCode()" class="px-3 py-2 bg-blue-600 text-white text-xs rounded-lg hover:bg-blue-700 transition-colors">
                                    Generar
                                </button>
                                <button type="button" onclick="autoGenerateCode()" class="px-3 py-2 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-colors">
                                    Auto
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 bg-white rounded border">
                            <label for="doc-code" class="block text-xs font-medium text-gray-700 mb-1">Código Generado *</label>
                            <input type="text" id="doc-code" name="code" required readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-mono" placeholder="B18PA003A-SHY-ZPF-70-001-A">
                        </div>
                    </div>
                    
                    <div>
                        <label for="doc-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Documento *</label>
                        <input type="text" id="doc-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Diagrama Unifilar Principal">
                    </div>
                    
                    <div>
                        <label for="doc-responsible" class="block text-sm font-medium text-gray-700 mb-1">Responsable *</label>
                        <input type="text" id="doc-responsible" name="responsible" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="A. Vargas">
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Valores por Defecto:</h4>
                        <div class="text-xs text-gray-600 space-y-1">
                            <p><strong>Revisión:</strong> A</p>
                            <p><strong>Estado:</strong> En Elaboración</p>
                            <p><strong>Costo:</strong> $0</p>
                            <p><strong>Fechas:</strong> Sin especificar</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddDocumentModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                            Añadir Documento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md transform transition-all">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold">Perfil de Usuario</h3>
                    <button onclick="closeUserProfileModal()" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="flex flex-col items-center space-y-4">
                    <img class="h-20 w-20 rounded-full object-cover border-4 border-gray-200" src="https://placehold.co/150x150/e2e8f0/64748b?text=CR" alt="User profile">
                    <div class="text-center">
                        <h4 class="text-lg font-semibold text-gray-900">Carlos Rodriguez</h4>
                        <p class="text-sm text-gray-500">Gerente de Proyecto</p>
                        <p class="text-xs text-gray-400 mt-1">ID: EMP-001</p>
                    </div>
                </div>

                <div class="mt-6 space-y-4">
                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Correo Electrónico</p>
                            <p class="text-sm text-gray-500">c.rodriguez@proyectocorp.com</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Teléfono</p>
                            <p class="text-sm text-gray-500">+593 99 123 4567</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Departamento</p>
                            <p class="text-sm text-gray-500">Gerencia de Proyectos</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10m0 0l-2-2m2 2l2-2m2 6H6"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Proyecto Actual</p>
                            <p class="text-sm text-gray-500">Palo Azul - Fase II</p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Fecha de Ingreso</p>
                            <p class="text-sm text-gray-500">Enero 2020</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div class="flex space-x-3">
                        <button onclick="closeUserProfileModal()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                            Cerrar
                        </button>
                        <button onclick="editProfile()" class="flex-1 px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-md hover:opacity-90">
                            Editar Perfil
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Modal -->
    <div id="recent-activity-modal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] transform transition-all flex flex-col">
            <div class="p-6 border-b flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold flex items-center">
                        <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        Historial Completo de Actividad
                    </h3>
                    <button onclick="closeRecentActivityModal()" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div id="recent-activity-content">
                    <!-- Recent activity content will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- DATA ---
        // Notifications Data
        const notificationsData = [
            {
                id: 1,
                type: "document_approval",
                title: "Documento Aprobado",
                message: "El documento PA-PRO-PID-001 ha sido aprobado por el cliente",
                timestamp: "2025-01-15T10:30:00Z",
                read: false,
                priority: "high",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                documentCode: "PA-PRO-PID-001",
                documentName: "Diagrama de Flujo de Proceso",
                icon: "check-circle",
                color: "green"
            },
            {
                id: 2,
                type: "document_revision",
                title: "Documento Requiere Revisión",
                message: "El documento B57SH23001-SCP-02-001 necesita revisión interna",
                timestamp: "2025-01-15T09:15:00Z",
                read: false,
                priority: "medium",
                projectId: "proj-004",
                projectName: "Bombas de Reinyección de Agua",
                documentCode: "B57SH23001-SCP-02-001",
                documentName: "DATA SHEET BOMBA DE REINYECCIÓN",
                icon: "exclamation-triangle",
                color: "yellow"
            },
            {
                id: 3,
                type: "transmittal_received",
                title: "Transmittal Recibido",
                message: "Se recibió el transmittal SUB-A-TR-005 de Subcontratista A",
                timestamp: "2025-01-15T08:45:00Z",
                read: false,
                priority: "medium",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                transmittalCode: "SUB-A-TR-005",
                transmittalSubject: "Memorias de Cálculo Civiles",
                icon: "inbox",
                color: "blue"
            },
            {
                id: 4,
                type: "deadline_approaching",
                title: "Fecha Límite Próxima",
                message: "El documento PA-ELE-SLD-001 vence en 2 días",
                timestamp: "2025-01-14T16:20:00Z",
                read: true,
                priority: "high",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                documentCode: "PA-ELE-SLD-001",
                documentName: "Diagrama Unifilar Principal",
                icon: "clock",
                color: "orange"
            },
            {
                id: 5,
                type: "document_rejected",
                title: "Documento Rechazado",
                message: "El documento B57SH23001-SCP-42-001 fue rechazado por el cliente",
                timestamp: "2025-01-14T14:30:00Z",
                read: true,
                priority: "high",
                projectId: "proj-004",
                projectName: "Bombas de Reinyección de Agua",
                documentCode: "B57SH23001-SCP-42-001",
                documentName: "DIAGRAMA UNIFILAR DE FUERZA",
                icon: "x-circle",
                color: "red"
            },
            {
                id: 6,
                type: "new_document",
                title: "Nuevo Documento Cargado",
                message: "J. Perez cargó la Rev. B del documento PA-MEC-DTS-101",
                timestamp: "2025-01-14T11:15:00Z",
                read: true,
                priority: "low",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                documentCode: "PA-MEC-DTS-101",
                documentName: "Hoja de Datos - Bomba P-101",
                icon: "document-plus",
                color: "blue"
            },
            {
                id: 7,
                type: "project_update",
                title: "Actualización de Proyecto",
                message: "El proyecto Palo Azul - Fase II alcanzó 85% de avance",
                timestamp: "2025-01-13T15:45:00Z",
                read: true,
                priority: "low",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                icon: "chart-bar",
                color: "green"
            },
            {
                id: 8,
                type: "comment_added",
                title: "Nuevo Comentario",
                message: "Se agregó un comentario al documento PA-CIV-LYT-005",
                timestamp: "2025-01-13T10:20:00Z",
                read: true,
                priority: "low",
                projectId: "proj-001",
                projectName: "Palo Azul - Fase II",
                documentCode: "PA-CIV-LYT-005",
                documentName: "Memoria de Cálculo Estructural",
                icon: "chat-bubble-left",
                color: "purple"
            }
        ];

        const mockData = {
            projects: {
                "proj-001": { 
                    name: "Palo Azul - Fase II", manager: "Carlos Rodriguez", location: "Orellana, Ecuador", status: "En Ejecución", overallProgress: 85, 
                    kpis: { overdue: 3, inReview: 8, approved: 152, pendingTasks: 5, cycleTime: "6.2 Días", docStatus: { approved: 60, forApproval: 15, clientReview: 10, internalReview: 5 } },
                    pendingTasks: [
                        { id: 1, title: "Revisar Transmittal TR-021", type: "Revisión", priority: "Alta", assignee: "C. Rodriguez", dueDate: "2025-01-20", status: "En Progreso", description: "Revisar comentarios del cliente en transmittal de P&IDs" },
                        { id: 2, title: "Aprobar Memoria de Cálculo MEM-005", type: "Aprobación", priority: "Media", assignee: "A. Vargas", dueDate: "2025-01-22", status: "Pendiente", description: "Aprobar memoria de cálculo estructural para cimentaciones" },
                        { id: 3, title: "Actualizar Lista Maestra de Documentos", type: "Actualización", priority: "Baja", assignee: "J. Perez", dueDate: "2025-01-25", status: "Pendiente", description: "Actualizar LMD con nuevos documentos emitidos" },
                        { id: 4, title: "Preparar Presentación Semanal", type: "Reporte", priority: "Media", assignee: "M. Solis", dueDate: "2025-01-18", status: "En Progreso", description: "Preparar presentación de avance para reunión semanal" },
                        { id: 5, title: "Validar Especificaciones Técnicas", type: "Validación", priority: "Alta", assignee: "L. Castro", dueDate: "2025-01-19", status: "Pendiente", description: "Validar especificaciones técnicas con cliente" }
                    ],
                    team: [
                        {name: 'Carlos R.', initials: 'CR', discipline: 'Procesos', role: 'Líder de Proyecto'}, 
                        {name: 'Ana V.', initials: 'AV', discipline: 'Mecánica', role: 'Ingeniero Senior'}, 
                        {name: 'Juan P.', initials: 'JP', discipline: 'Eléctrica', role: 'Ingeniero'}, 
                        {name: 'Maria S.', initials: 'MS', discipline: 'I&C', role: 'Ingeniero'}
                    ],
                    overdueDocuments: [ {code: 'PA-CIV-LYT-005', responsible: 'L. Castro', days: 3}, {code: 'PA-ELE-SLD-002', responsible: 'M. Solis', days: 2}, {code: 'PA-MEC-DTS-105', responsible: 'J. Perez', days: 1}, ],
                    documentsByDiscipline: { labels: ['Procesos', 'Mecánica', 'Eléctrica', 'I&C', 'Civil', 'Tuberías'], data: [95, 88, 80, 75, 65, 70] },
                    documents: [ 
                        { name: "Diagrama de Flujo de Proceso", code: "B12EY007A-SHY-PCC-10-PID-001", rev: "0", date: "2023-08-15", status: "Aprobado para Construcción", responsible: "A. Vargas", fechaEnvio: "2023-08-10", fechaAprobacion: "2023-08-15", cost: 15000, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}] }, 
                        { name: "Hoja de Datos - Bomba P-101", code: "B12EY007A-SHY-PCC-20-DS-101", rev: "0", date: "2023-09-01", status: "Aprobado con Comentarios", responsible: "J. Perez", fechaEnvio: "2023-08-28", fechaAprobacion: "2023-09-01", cost: 8500, files: [{type: 'pdf', link: '#'}, {type: 'xlsx', link: '#'}] }, 
                        { name: "Plano de Tuberías Isométrico", code: "B12EY007A-SHY-PCC-50-ISO-088", rev: "C", date: "2023-09-12", status: "Enviado a CDD", responsible: "R. Diaz", fechaEnvio: "2023-09-05", fechaAprobacion: null, cost: 12000, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}]}, 
                        { name: "Diagrama Unifilar Principal", code: "B12EY007A-SHY-PCC-70-SLD-001", rev: "C", date: "2023-07-20", status: "En Revisión", responsible: "M. Solis", fechaEnvio: "2023-07-15", fechaAprobacion: null, cost: 18000, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}] }, 
                        { name: "Memoria de Cálculo Estructural", code: "B12EY007A-SHY-PCC-30-MDC-005", rev: "B", date: "2023-09-10", status: "Comentado", responsible: "L. Castro", fechaEnvio: "2023-09-08", fechaAprobacion: null, cost: 22000, files: [{type: 'pdf', link: '#'}, {type: 'docx', link: '#'}] },
                        { name: "Especificación Técnica de Válvulas", code: "B12EY007A-SHY-PCC-20-ESP-102", rev: "A", date: "2023-08-25", status: "En Elaboración", responsible: "J. Perez", fechaEnvio: null, fechaAprobacion: null, cost: 9500, files: [{type: 'docx', link: '#'}] },
                        { name: "Diagrama de Instrumentación", code: "B12EY007A-SHY-PCC-60-PID-003", rev: "0", date: "2023-09-05", status: "Aprobado para Construcción", responsible: "M. Solis", fechaEnvio: "2023-08-30", fechaAprobacion: "2023-09-05", cost: 13500, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}] },
                        { name: "Lista de Cables", code: "B12EY007A-SHY-PCC-70-LST-201", rev: "B", date: "2023-08-20", status: "Rechazado", responsible: "A. Vargas", fechaEnvio: "2023-08-18", fechaAprobacion: null, cost: 7500, files: [{type: 'xlsx', link: '#'}] }
                    ], 
                    adminDocs: [ { name: "Alcance del Proyecto Rev. A", type: "Alcance", date: "2023-01-15", link: "#" }, { name: "Acta de Reunión Kick-off", type: "Acta", date: "2023-01-20", link: "#" } ], 
                    sCurveData: { labels: ["Sem 1", "Sem 2", "Sem 3", "Sem 4", "Sem 5", "Sem 6", "Sem 7", "Sem 8"], planned: [5, 15, 30, 50, 70, 85, 95, 100], actual: [2, 12, 28, 52, 75, 85, null, null] }, 
                    recentActivity: [
                        { user: "J. Perez", action: "cargó la Rev. B del documento", docCode: "PA-MEC-DTS-101", time: "Hace 2 horas" },
                        { user: "Cliente", action: "aprobó el documento", docCode: "PA-PRO-PID-001", time: "Hace 1 día" },
                        { user: "M. Solis", action: "comentó en la Rev. A del documento", docCode: "PA-ELE-SLD-001", time: "Hace 3 días" },
                        { user: "A. Vargas", action: "rechazó la Rev. 2 del documento", docCode: "PA-CIV-LYT-005", time: "Hace 1 semana" },
                        { user: "L. Castro", action: "envió para aprobación la Rev. C del documento", docCode: "PA-PRO-PID-002", time: "Hace 1 semana" },
                        { user: "R. Diaz", action: "actualizó el estado del documento", docCode: "PA-MEC-DTS-102", time: "Hace 2 semanas" },
                        { user: "Cliente", action: "aprobó con comentarios el documento", docCode: "PA-ELE-SLD-002", time: "Hace 3 semanas" },
                        { user: "J. Perez", action: "cargó archivos adicionales al documento", docCode: "PA-PRO-PID-001", time: "Hace 1 mes" }
                    ] 
                },
                "proj-004": { 
                    name: "Bombas de Reinyección de Agua", manager: "D. Solis", location: "Shushufindi, Ecuador", status: "En Ejecución", overallProgress: 72, 
                    kpis: { overdue: 1, inReview: 5, approved: 80, pendingTasks: 2, cycleTime: "8.1 Días", docStatus: { approved: 45, forApproval: 20, clientReview: 25, internalReview: 10 } },
                    pendingTasks: [
                        { id: 1, title: "Revisar Especificaciones de Bombas", type: "Revisión", priority: "Alta", assignee: "D. Solis", dueDate: "2025-01-21", status: "En Progreso", description: "Revisar especificaciones técnicas de bombas de reinyección" },
                        { id: 2, title: "Actualizar Cronograma de Proyecto", type: "Planificación", priority: "Media", assignee: "M. Lopez", dueDate: "2025-01-23", status: "Pendiente", description: "Actualizar cronograma basado en avance real del proyecto" }
                    ],
                    team: [
                        {name: 'David S.', initials: 'DS', discipline: 'Procesos', role: 'Líder de Proyecto'}, 
                        {name: 'Maria L.', initials: 'ML', discipline: 'Mecánica', role: 'Ingeniero Senior'}, 
                        {name: 'Luis V.', initials: 'LV', discipline: 'Civil', role: 'Ingeniero'}
                    ],
                    overdueDocuments: [{code: 'B57-SCP-42-001', responsible: 'M. Lopez', days: 5}],
                    documentsByDiscipline: { labels: ['General', 'Procesos', 'Mecánica', 'Tuberías', 'Eléctrica', 'I&C', 'Civil'], data: [5, 10, 25, 15, 18, 20, 12] },
                    documents: [ 
                        { name: "LISTADO MASTER DOCUMENTOS", code: "B57SH23001-SCP-05-LMD-001", rev: "1", date: "2023-06-14", status: "Aprobado", responsible: "J. Gomez", fechaEnvio: "2023-06-10", fechaAprobacion: "2023-06-14", cost: 5000, files: [{type: 'pdf', link: '#'}, {type: 'xlsx', link: '#'}] }, 
                        { name: "P&ID REINJECTION PUMPS SKID", code: "B57SH23001-SCP-01-001", rev: "C", date: "2023-04-11", status: "Para Revisión Cliente", responsible: "M. Lopez", fechaEnvio: "2023-04-08", fechaAprobacion: null, cost: 12000, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}] }, 
                        { name: "DATA SHEET BOMBA DE REINYECCIÓN", code: "B57SH23001-SCP-02-001", rev: "0", date: "2023-04-11", status: "Para Aprobación", responsible: "E. Torres", fechaEnvio: "2023-04-05", fechaAprobacion: null, cost: 8000, files: [{type: 'pdf', link: '#'}, {type: 'xlsx', link: '#'}] },
                        { name: "ESPECIFICACIÓN TÉCNICA BOMBAS", code: "B57SH23001-SCP-03-001", rev: "A", date: "2023-05-20", status: "Aprobado", responsible: "D. Solis", fechaEnvio: "2023-05-15", fechaAprobacion: "2023-05-20", cost: 10000, files: [{type: 'pdf', link: '#'}] },
                        { name: "DIAGRAMA UNIFILAR", code: "B57SH23001-SCP-04-001", rev: "B", date: "2023-06-01", status: "Revisión Interna", responsible: "L. Villafuerte", fechaEnvio: "2023-05-28", fechaAprobacion: null, cost: 15000, files: [{type: 'pdf', link: '#'}, {type: 'dwg', link: '#'}] }
                    ], 
                    adminDocs: [ { name: "Análisis de Oferta Técnica", type: "Análisis", date: "2023-02-10", link: "#" } ], 
                    sCurveData: { labels: ["Mes 1", "Mes 2", "Mes 3", "Mes 4", "Mes 5", "Mes 6"], planned: [10, 25, 45, 65, 85, 100], actual: [8, 22, 40, 68, 72, null] }, 
                    recentActivity: [
                        { user: "M. Lopez", action: "emitió para aprobación la Rev. 1 de", docCode: "B57SH23001-SCP-05-LMD-001", time: "Hace 1 semana" },
                        { user: "L. Villafuerte", action: "cargó la Rev. C del documento", docCode: "B57SH23001-SCP-61-001", time: "Hace 2 semanas" },
                        { user: "D. Solis", action: "aprobó la Rev. B del documento", docCode: "B57SH23001-SCP-03-001", time: "Hace 3 semanas" },
                        { user: "Cliente", action: "comentó en el documento", docCode: "B57SH23001-SCP-04-001", time: "Hace 1 mes" },
                        { user: "M. Lopez", action: "actualizó la especificación técnica", docCode: "B57SH23001-SCP-02-001", time: "Hace 1 mes" },
                        { user: "L. Villafuerte", action: "envió para revisión interna", docCode: "B57SH23001-SCP-06-001", time: "Hace 6 semanas" }
                    ] 
                },
                "proj-002": { name: "Optimización Compresores Sacha", manager: "Ana Torres", location: "Sacha, Ecuador", status: "Completado", overallProgress: 100, kpis: {overdue: 0, inReview: 0, approved: 250, pendingTasks: 0, cycleTime: "5.1 Días"}, disciplines: [], documents: [], adminDocs: [], sCurveData: { labels: ["T1", "T2", "T3", "T4"], planned: [25, 50, 75, 100], actual: [28, 55, 78, 100] }, recentActivity: [
                    { user: "A. Torres", action: "aprobó el documento final", docCode: "SC-OPT-001", time: "Hace 2 meses" },
                    { user: "Cliente", action: "aceptó el proyecto completado", docCode: "SC-FIN-001", time: "Hace 2 meses" },
                    { user: "Técnico", action: "cargó resultados de pruebas", docCode: "SC-TST-001", time: "Hace 3 meses" }
                ], team:[], overdueDocuments: [], documentsByDiscipline: {labels:[], data:[]} },
                "proj-003": { name: "Ingeniería Conceptual CPF", manager: "Luis Guzman", location: "Cuyabeno, Ecuador", status: "En Pausa", overallProgress: 25, kpis: {overdue: 0, inReview: 2, approved: 15, pendingTasks: 1, cycleTime: "7.0 Días"}, disciplines: [], documents: [], adminDocs: [], sCurveData: { labels: ["Fase 1", "Fase 2", "Fase 3"], planned: [33, 66, 100], actual: [25, null, null] }, recentActivity: [], team:[], overdueDocuments: [], documentsByDiscipline: {labels:[], data:[]} }
            },
            transmittals: [
                { id: 1, type: 'out', code: 'PHUB-PA-TR-021', project: 'Palo Azul - Fase II', from: 'ProjectHub Team', to: 'Cliente A', attn: 'Departamento de Ingeniería', date: '2023-09-20', method: 'E-Mail', purpose: 'Para revisión y comentarios', comments: 'Favor revisar los P&IDs actualizados según reunión del 18/09.', preparedBy: 'C. Rodriguez', documents: [ { item: 1, description: 'Diagrama de Flujo de Proceso', code: 'PA-PRO-PID-001', rev: 'C' }, { item: 2, description: 'Diagrama Unifilar Principal', code: 'PA-ELE-SLD-001', rev: 'B' } ], status: 'Enviado' },
                { id: 2, type: 'in', code: 'SUB-A-TR-005', project: 'Palo Azul - Fase II', from: 'Subcontratista A', to: 'ProjectHub Team', attn: 'L. Castro', date: '2023-09-18', method: 'Plataforma', purpose: 'Para aprobación', comments: 'Se adjuntan memorias de cálculo de cimentaciones.', preparedBy: 'Ing. Residente', documents: [ { item: 1, description: 'Memoria de Cálculo Estructural', code: 'PA-CIV-LYT-005', rev: 'A' } ], status: 'Recibido' },
            ],
            users: [ { id: 1, name: 'C. Rodriguez', email: 'c.rodriguez@proyectocorp.com', role: 'Líder de Proyecto', project: 'Palo Azul - Fase II' }, { id: 2, name: 'D. Solis', email: 'd.solis@proyectocorp.com', role: 'Líder de Proyecto', project: 'Bombas de Reinyección' }, { id: 3, name: 'A. Vargas', email: 'a.vargas@proyectocorp.com', role: 'Líder de Disciplina', project: 'Palo Azul - Fase II' }, { id: 4, name: 'Admin User', email: 'admin@proyectocorp.com', role: 'Administrador', project: 'Todos' } ]
        };

        // --- DOM ELEMENTS ---
        const dashboardHeader = document.getElementById('dashboard-header');
        const projectCardsContainer = document.getElementById('project-cards-container');
        const dashboardContent = document.getElementById('dashboard-content');
        const repositoryContent = document.getElementById('repository-content');
        const transmittalsContent = document.getElementById('transmittals-content');
        const reportsContent = document.getElementById('reports-content');
        const settingsContent = document.getElementById('settings-content');
        const mainNav = document.getElementById('main-nav');
        const projectFilters = document.getElementById('project-filters');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const transmittalModal = document.getElementById('transmittal-modal');
        const uploadDocModal = document.getElementById('upload-doc-modal');
        const createTransmittalBtn = document.getElementById('create-transmittal-btn');
        const uploadDocBtn = document.getElementById('upload-doc-btn');
        
        // --- RENDER FUNCTIONS ---
        const statusMap = { 'Aprobado': 'APR', 'Aprobado con Comentarios': 'ACC', 'Para Aprobación': 'PA', 'Para Revisión Cliente': 'PRC', 'Revisión Interna': 'RI', 'Aprobado Internamente': 'AI', 'Rechazado': 'REC' };

        function getProgressColor(p) { return p >= 80 ? 'bg-green-500' : p >= 50 ? 'bg-orange-400' : 'halli-red-bg'; }
        function getStatusClass(s) { 
            const classes = { 
                'Aprobado': 'status-aprobado', 
                'Aprobado con Comentarios': 'status-aprobado-comentarios', 
                'Comentado': 'status-comentado',
                'Rechazado': 'status-rechazado',
                'Aprobado para Construcción': 'status-aprobado-construccion',
                'Enviado a CDD': 'status-enviado-cdd',
                'Emitido para Revisión': 'status-emitido-revision',
                'En Revisión': 'status-en-revision',
                'Para Aprobación': 'status-para-aprobacion', 
                'Para Revisión Cliente': 'status-para-revision-cliente', 
                'Revisión Interna': 'status-revision-interna', 
                'Aprobado Internamente': 'status-aprobado-internamente', 
                'Para Aprobación Construcción': 'status-para-aprobacion', 
                'En Elaboración': 'status-en-elaboracion'
            }; 
            return classes[s] || 'bg-gray-200 text-gray-800'; 
        }

        function getFileIcon(type) {
            const icons = {
                pdf: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm3 3a1 1 0 000 2h6a1 1 0 100-2H7zM7 9a1 1 0 000 2h2a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`,
                dwg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
                xlsx: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm2 10h8a1 1 0 100-2H6a1 1 0 100 2zm0-4h8a1 1 0 100-2H6a1 1 0 100 2z" clip-rule="evenodd" /></svg>`,
                docx: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4zm2 6a1 1 0 100 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>`,
                dwf: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
                txt: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`,
                zip: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>`,
            };
            return icons[type] || `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>`;
        }

        function renderProjectCards(filterStatus = "En Ejecución") {
            const filteredProjects = Object.entries(mockData.projects).filter(([id, p]) => p.status === filterStatus);
            if (filteredProjects.length === 0) { projectCardsContainer.innerHTML = `<div class="text-center p-10 bg-white rounded-lg shadow"><p class="halli-medium-text">No hay proyectos con el estado "${filterStatus}".</p></div>`; return; }
            projectCardsContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${ filteredProjects.map(([id, p]) => `<div data-project-id="${id}" class="project-card bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer"><h3 class="font-bold text-lg halli-dark-text">${p.name}</h3><p class="text-sm text-gray-500">${p.location}</p><div class="mt-4"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium">Avance</span><span class="text-sm font-bold">${p.overallProgress}%</span></div><div class="w-full progress-bar-bg rounded-full h-2"><div class="${getProgressColor(p.overallProgress)} h-2 rounded-full" style="width: ${p.overallProgress}%"></div></div></div><div class="mt-4 text-xs text-gray-500"><p><strong>Líder:</strong> ${p.manager}</p></div></div>`).join('') }</div>`;
            document.querySelectorAll('.project-card').forEach(card => card.addEventListener('click', () => showDashboardDetail(card.dataset.projectId)));
        }
        
        let sCurveChart = null, docStatusChart = null, costProgressChart = null;
        function renderDashboard(projectId) {
            const p = mockData.projects[projectId];
            if (!p) return;

            // Store current project ID in dataset
            dashboardContent.dataset.projectId = projectId;

            dashboardContent.innerHTML = `
                <!-- Dashboard KPI Icons -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Estado de Documentos Icon -->
                    <div class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="openModal('docStatusModal')">
                        <h3 class="text-sm font-medium text-gray-700 mb-3 text-center">% de Avance</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                                <div class="text-center">
                                    <p class="text-xs font-medium text-green-700 mb-1">Real</p>
                                    <p id="actualProgressKPI" class="text-sm font-bold text-green-600">${p.overallProgress}%</p>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                <div class="text-center">
                                    <p class="text-xs font-medium text-blue-700 mb-1">Proyectado</p>
                                    <p id="projectedProgressKPI" class="text-sm font-bold text-blue-600">87.5%</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Costo Total Icon -->
                    <div class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="openModal('costModal')">
                        <h3 class="text-sm font-medium text-gray-700 mb-3 text-center">Costo del Proyecto</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-green-50 p-3 rounded-lg border-l-4 border-green-500">
                                <div class="text-center">
                                    <p class="text-xs font-medium text-green-700 mb-1">Ejecutado</p>
                                    <p id="costExecuted" class="text-sm font-bold text-green-600">$90,100</p>
                                </div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
                                <div class="text-center">
                                    <p class="text-xs font-medium text-blue-700 mb-1">Proyectado</p>
                                    <p id="costProjected" class="text-sm font-bold text-blue-600">$106,000</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Avance por Disciplina Icon -->
                    <div class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="openModal('disciplineModal')">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative mb-3">
                                <svg class="w-12 h-12 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                                            </svg>
                                <div class="absolute -top-1 -right-1 bg-orange-100 text-orange-800 text-xs font-bold rounded-full px-2 py-1">
                                    5
                                    </div>
                                </div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Disciplinas</h3>
                            <p class="text-xs text-gray-500">Avance</p>
                            </div>
                    </div>

                    <!-- Equipo Icon -->
                    <div class="bg-white rounded-lg shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow" onclick="openModal('teamModal')">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative mb-3">
                                <svg class="w-12 h-12 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                                </svg>
                                <div class="absolute -top-1 -right-1 bg-purple-100 text-purple-800 text-xs font-bold rounded-full px-2 py-1">
                                    ${p.team.length}
                                </div>
                            </div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Equipo</h3>
                            <p class="text-xs text-gray-500">Miembros</p>
                        </div>
                    </div>
                </div>
               

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow-sm">
                            <!-- Tab Navigation -->
                            <div class="border-b border-gray-200">
                                <nav class="flex space-x-8 px-6" aria-label="Tabs">
                                    <button onclick="switchChartTab('s-curve')" id="s-curve-tab" class="chart-tab active py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                                        Curva S de Avance
                                    </button>
                                    <button onclick="switchChartTab('cost-progress')" id="cost-progress-tab" class="chart-tab py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        Gráfico de Avance en Costo
                                    </button>
                                </nav>
                            </div>
                            
                            <!-- Tab Content -->
                            <div class="p-6">
                                <div id="s-curve-content" class="chart-content">
                                    <h3 class="text-lg font-semibold mb-4 halli-dark-text">Curva S de Avance</h3>
                                    <div class="relative h-80">
                                        <canvas id="sCurveChart"></canvas>
                                    </div>
                                </div>
                                <div id="cost-progress-content" class="chart-content hidden">
                                    <h3 class="text-lg font-semibold mb-4 halli-dark-text">Gráfico de Avance en Costo</h3>
                                    <div class="relative h-80">
                                        <canvas id="costProgressChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white rounded-lg shadow-sm">
                            <button class="accordion-header w-full p-6 text-left flex justify-between items-center hover:bg-gray-50 transition-colors" onclick="toggleAccordion('tareas-pendientes')">
                                <div class="flex items-center space-x-4">
                                    <h3 class="text-lg font-semibold halli-dark-text">Tareas Pendientes</h3>
                                    <span class="bg-red-100 text-red-800 text-sm font-bold px-2 py-1 rounded-full">${p.kpis.pendingTasks}</span>
                                </div>
                                <svg class="accordion-icon w-5 h-5 text-gray-500 transition-transform" id="tareas-pendientes-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="accordion-content hidden" id="tareas-pendientes-content">
                                <div class="px-6 pb-6">
                                    <div class="space-y-4">
                                        ${renderPendingTasksList(p.pendingTasks)}
                                    </div>
                                    <div class="pt-4 border-t border-gray-200 mt-4">
                                        <button class="w-full flex items-center justify-center space-x-2 p-3 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            <span>Crear nueva tarea</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-sm"><h3 class="text-lg font-semibold mb-4 halli-dark-text">Actividad Reciente</h3><ul>${p.recentActivity.slice(0, 4).map(a=>`<li class="flex items-start space-x-3 pb-4"><div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-sm halli-medium-text">${a.user.substring(0,1)}.</div><div><p class="text-sm"><span class="font-semibold">${a.user}</span> ${a.action} <span class="font-semibold text-red-600">${a.docCode}</span></p><p class="text-xs text-gray-500">${a.time}</p></div></li>`).join('')}</ul>${p.recentActivity.length > 4 ? `<button onclick="showRecentActivityModal(document.querySelector('#dashboard-content').dataset.projectId)" class="w-full mt-4 px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">Mostrar más</button>` : ''}</div>
                    </div>

                 
                </div>
                    <!-- Full Width Document Table -->
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <h3 class="text-lg font-semibold halli-dark-text mb-4 md:mb-0">Lista Maestra de Documentos</h3>
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                            <button onclick="showAddDocumentModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Añadir Documento
                            </button>
                        <div class="relative w-full md:w-80">
                            <input type="text" id="documentSearch" placeholder="Buscar por código, nombre o responsable..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="border-b bg-gray-50">
                                    <th class="py-3 px-2 font-semibold text-center">#</th>
                                    <th class="py-3 px-2 font-semibold">Documento</th>
                                    <th class="py-3 px-2 font-semibold">Responsable</th>
                                    <th class="py-3 px-2 font-semibold">Disciplina</th>
                                    <th class="py-3 px-2 font-semibold text-center">Estado</th>
                                    <th class="py-3 px-2 font-semibold text-center">Rev.</th>
                                    <th class="py-3 px-2 font-semibold text-center">Fecha Envío</th>
                                    <th class="py-3 px-2 font-semibold text-center">Fecha Aprobación</th>
                                    <th class="py-3 px-2 font-semibold text-center">Costo</th>
                                    <th class="py-3 px-2 font-semibold text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody">
                                ${renderDocumentsTable(p.documents)}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            
            // Initialize charts
            renderSCurveChart(p);
            renderCostProgressChart(p);

            // Show S-curve by default
            switchChartTab('s-curve');
            renderDisciplineProgressBars(p.documentsByDiscipline);
            setupDocumentSearch(projectId);
            setupDocumentActions();

            // Populate cost KPI
            populateCostModal(p);
        }

        function renderSCurveChart(project) {
            if(sCurveChart) sCurveChart.destroy();
            sCurveChart = new Chart(document.getElementById('sCurveChart').getContext('2d'), { 
                type: 'line', 
                data: { 
                    labels: project.sCurveData.labels, 
                    datasets: [ 
                        { 
                            label: 'Planificado', 
                            data: project.sCurveData.planned, 
                            borderColor: '#DA291C', 
                            backgroundColor: 'rgba(218, 41, 28, 0.1)', 
                            borderWidth: 2, 
                            fill: true, 
                            tension: 0.3 
                        }, 
                        { 
                            label: 'Real', 
                            data: project.sCurveData.actual, 
                            borderColor: '#58595b', 
                            backgroundColor: 'rgba(88, 89, 91, 0.1)', 
                            borderWidth: 2, 
                            fill: true, 
                            tension: 0.3 
                        } 
                    ] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            max: 100, 
                            ticks: { 
                                callback: v => `${v}%` 
                            } 
                        } 
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                } 
            });
        }

        function renderCostProgressChart(project) {
            if (costProgressChart) costProgressChart.destroy();
            
            // Generate cost progress data based on document dates and costs
            const costData = generateCostProgressData(project);
            
            costProgressChart = new Chart(document.getElementById('costProgressChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: costData.labels,
                    datasets: [
                        {
                            label: 'Proyectado Acumulado',
                            data: costData.projected,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Real Acumulado',
                            data: costData.actual,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchChartTab(tabName) {
            // Hide all chart contents
            document.querySelectorAll('.chart-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected content and activate tab
            const selectedContent = document.getElementById(tabName + '-content');
            const selectedTab = document.getElementById(tabName + '-tab');
            
            if (selectedContent && selectedTab) {
                selectedContent.classList.remove('hidden');
                selectedTab.classList.add('active', 'border-blue-500', 'text-blue-600');
                selectedTab.classList.remove('border-transparent', 'text-gray-500');
            }
            
            // Resize charts after tab switch
            setTimeout(() => {
                if (tabName === 's-curve' && sCurveChart) {
                    sCurveChart.resize();
                } else if (tabName === 'cost-progress' && costProgressChart) {
                    costProgressChart.resize();
                }
            }, 100);
        }

        function calculateTotalProjectCost(documents) {
            return documents.reduce((sum, doc) => sum + (doc.cost || 0), 0);
        }

        function generateCostProgressData(project) {
            // Get all documents with their costs and dates
            const documents = project.documents || [];
            
            // Create monthly data structure
            const monthlyData = {};
            const totalProjectedCost = documents.reduce((sum, doc) => sum + (doc.cost || 0), 0);
            
            // Generate projected costs (distributed over time)
            const months = ['Jun-23', 'Jul-23', 'Aug-23', 'Sep-23', 'Oct-23', 'Nov-23', 'Dec-23', 'Jan-24'];
            const projectedCosts = [491, 49014.853, 88000, 110000, 120000, 140000, 188918.27, 245442.430];
            
            // Generate actual costs (based on document completion status)
            const actualCosts = [0, 0, 0, 37116.57, 37116.57, 37116.57, 188918.27, 0];
            
            return {
                labels: months,
                projected: projectedCosts,
                actual: actualCosts
            };
        }

        function renderDisciplineProgressBars(disciplineData) {
            const container = document.getElementById('disciplineProgressBars');
            if (!container || !disciplineData.labels || !disciplineData.data) return;

            // Use the data values directly as percentages
            const progressData = disciplineData.labels.map((label, index) => ({
                label: label,
                percentage: disciplineData.data[index]
            }));

            // Sort by percentage (highest first) and limit to top 5 to include Civil
            progressData.sort((a, b) => b.percentage - a.percentage);
            const topDisciplines = progressData.slice(0, 5);

            // Define colors for different progress levels
            const getProgressColor = (percentage) => {
                if (percentage >= 90) return 'bg-green-500';
                if (percentage >= 70) return 'bg-orange-400';
                return 'bg-red-500';
            };

            container.innerHTML = topDisciplines.map(item => `
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-700">${item.label}</span>
                        <span class="text-xs font-bold text-gray-900">${item.percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${getProgressColor(item.percentage)} h-2 rounded-full transition-all duration-500" 
                             style="width: ${item.percentage}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderDocumentStatusList(docStatus) {
            if (!docStatus) return '';
            
            // Map the data keys to display labels
            const statusMap = {
                approved: 'Aprobado',
                forApproval: 'Para Aprobación', 
                clientReview: 'Rev. Cliente',
                internalReview: 'Rev. Interna'
            };
            
            // Create the status list items
            const statusItems = Object.entries(statusMap).map(([key, label]) => {
                const percentage = docStatus[key] || 0;
                return `
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-700">${label}</span>
                        <span class="text-sm font-bold text-gray-900">${percentage}%</span>
                    </div>
                `;
            }).join('');
            
            return statusItems;
        }

        function renderDocumentStatusWithProgress(docStatus) {
            if (!docStatus) return '';
            
            // Map the data keys to display labels and colors
            const statusConfig = {
                approved: { 
                    label: 'Aprobado', 
                    color: 'bg-green-500',
                    textColor: 'text-gray-700'
                },
                forApproval: { 
                    label: 'Para Aprobación', 
                    color: 'bg-blue-500',
                    textColor: 'text-gray-700'
                },
                clientReview: { 
                    label: 'Rev. Cliente', 
                    color: 'bg-orange-400',
                    textColor: 'text-gray-700'
                },
                internalReview: { 
                    label: 'Rev. Interna', 
                    color: 'bg-gray-500',
                    textColor: 'text-gray-700'
                }
            };
            
            // Create the status items with progress bars
            const statusItems = Object.entries(statusConfig).map(([key, config]) => {
                const percentage = docStatus[key] || 0;
                return `
                    <div class="mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-medium ${config.textColor}">${config.label}</span>
                            <span class="text-xs font-bold text-gray-900">${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${config.color} h-2 rounded-full transition-all duration-500" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return statusItems;
        }

        function toggleAccordion(accordionId) {
            const content = document.getElementById(`${accordionId}-content`);
            const icon = document.getElementById(`${accordionId}-icon`);
            
            if (content && icon) {
                if (content.classList.contains('hidden')) {
                    // Expand accordion
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    // Collapse accordion
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        // Modal functions
        function openModal(modalOrId) {
            try {
                console.log('Opening modal:', modalOrId);

                // Wait for DOM to be ready if needed
                if (document.readyState === 'loading') {
                    console.log('DOM still loading, waiting...');
                    document.addEventListener('DOMContentLoaded', () => openModal(modalOrId));
                    return;
                }

                // Handle both string IDs and DOM elements
                let modal;
                let modalId;
                if (typeof modalOrId === 'string') {
                    // It's a string ID, find the element
                    modal = document.getElementById(modalOrId);
                    modalId = modalOrId;
                    console.log('Modal element found:', !!modal);
                } else {
                    // It's already a DOM element
                    modal = modalOrId;
                    modalId = modal.id;
                    console.log('Modal element provided directly');
                }
                
                if (!modal) {
                    console.error('Modal not found:', modalId);
                    console.log('Available elements with similar IDs:');
                    const allElements = document.querySelectorAll('[id*="Modal"]');
                    allElements.forEach(el => console.log('- ', el.id));
                    return;
                }
                
                // Get current project data
                const currentProjectId = getCurrentProjectId();
                console.log('Current project ID:', currentProjectId);
                
                if (currentProjectId && mockData && mockData.projects) {
                    const project = mockData.projects[currentProjectId];
                    console.log('Project data found:', !!project);
                    
                    if (project) {
                        // Populate modal with current project data
                        try {
                            populateModal(modalId, project);
                        } catch (populateError) {
                            console.error('Error populating modal:', populateError);
                        }
                    }
                }
                
                // Show modal
                if (modal && modal.classList) {
                    modal.classList.remove('hidden');
                    if (modalBackdrop) {
                        modalBackdrop.classList.remove('hidden');
                    }
                    document.body.style.overflow = 'hidden';
                    console.log('Modal opened successfully');
                } else {
                    console.error('Modal element is invalid:', modal);
                }
                
            } catch (error) {
                console.error('Error opening modal:', error);
                console.error('Error stack:', error.stack);
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            // Also hide the backdrop
            if (modalBackdrop) {
                modalBackdrop.classList.add('hidden');
            }
        }

        function populateModal(modalId, project) {
            switch(modalId) {
                case 'docStatusModal':
                    populateDocStatusModal(project);
                    break;
                case 'costModal':
                    populateCostModal(project);
                    break;
                case 'disciplineModal':
                    populateDisciplineModal(project);
                    break;
                case 'teamModal':
                    populateTeamModal(project);
                    break;
            }
        }

        function populateDocStatusModal(project) {
            const progressElement = document.getElementById('docStatusProgress');
            const contentElement = document.getElementById('docStatusContent');
            
            if (progressElement) {
                progressElement.textContent = `${project.overallProgress}%`;
            }
            
            if (contentElement) {
                contentElement.innerHTML = renderDocumentStatusWithProgress(project.kpis.docStatus);
            }
        }

        function populateCostModal(project) {
            const currentProjectId = getCurrentProjectId();
            if (!currentProjectId) {
                console.error('No current project ID found');
                return;
            }

            // Fetch discipline cost data from API
            fetch(`/dashboard/api/project/${currentProjectId}/discipline-costs/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Cost data received:', data);
                updateCostModalUI(data);
            })
            .catch(error => {
                console.error('Error fetching cost data:', error);
                // Fallback to mock data if API fails
                const mockCostData = generateMockCostData(project);
                updateCostModalUI(mockCostData);
            });
        }

        function updateCostModalUI(data) {
            // Update summary cards
            document.getElementById('totalProjectedCost').textContent = `$${data.total_projected.toLocaleString()}`;
            document.getElementById('totalExecutedCost').textContent = `$${data.total_executed.toLocaleString()}`;
            document.getElementById('totalVariance').textContent = `$${data.total_variance.toLocaleString()}`;
            document.getElementById('totalVariancePercent').textContent = `${((data.total_variance / data.total_projected) * 100).toFixed(1)}%`;
            document.getElementById('overallCPI').textContent = data.overall_cpi.toFixed(2);

            // Update variance color
            const varianceElement = document.getElementById('totalVariance');
            const variancePercent = (data.total_variance / data.total_projected) * 100;
            if (variancePercent > 10) {
                varianceElement.classList.add('text-red-600');
                varianceElement.classList.remove('text-green-600');
            } else if (variancePercent > -5) {
                varianceElement.classList.add('text-green-600');
                varianceElement.classList.remove('text-red-600');
            } else {
                varianceElement.classList.remove('text-red-600', 'text-green-600');
            }

            // Populate discipline cost cards
            const container = document.getElementById('disciplineCostContainer');
            if (container) {
                container.innerHTML = data.discipline_costs.map(cost => createDisciplineCostCard(cost)).join('');
            }
        }

        function createDisciplineCostCard(cost) {
            const variancePercent = cost.variance_percentage;
            const statusColor = getStatusColorClass(cost.status_color);
            const progressPercent = cost.progress_percentage;

            return `
                <div class="bg-white rounded-lg border border-gray-200 p-6 hover:shadow-md transition-shadow">
                    <!-- Header -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${cost.discipline_color}"></div>
                            <div>
                                <h5 class="font-semibold text-gray-900">${cost.discipline_name}</h5>
                                <p class="text-sm text-gray-500">${cost.discipline_code}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium ${statusColor.text}">${cost.status_color === 'red' ? 'Sobrepresupuesto' : cost.status_color === 'green' ? 'En presupuesto' : 'Subpresupuesto'}</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progreso</span>
                            <span>${progressPercent.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-300" style="width: ${progressPercent}%; background-color: ${cost.discipline_color}"></div>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-xs text-gray-500 mb-1">Proyectado</p>
                            <p class="font-semibold text-gray-900">$${cost.projected_cost.toLocaleString()}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-xs text-gray-500 mb-1">Ejecutado</p>
                            <p class="font-semibold text-gray-900">$${cost.executed_cost.toLocaleString()}</p>
                        </div>
                    </div>

                    <!-- Cost Details -->
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Mano de obra:</span>
                            <span class="font-medium">$${cost.labor_cost.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Materiales:</span>
                            <span class="font-medium">$${cost.material_cost.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Equipos:</span>
                            <span class="font-medium">$${cost.equipment_cost.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subcontratistas:</span>
                            <span class="font-medium">$${cost.subcontractor_cost.toLocaleString()}</span>
                        </div>
                    </div>

                    <!-- Performance Metrics -->
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <p class="text-xs text-gray-500 mb-1">Varianza</p>
                                <p class="font-semibold ${variancePercent > 0 ? 'text-red-600' : variancePercent > -10 ? 'text-yellow-600' : 'text-green-600'}">
                                    ${variancePercent > 0 ? '+' : ''}${variancePercent.toFixed(1)}%
                                </p>
                            </div>
                            <div class="text-center">
                                <p class="text-xs text-gray-500 mb-1">CPI</p>
                                <p class="font-semibold ${cost.cost_performance_index < 0.9 ? 'text-red-600' : cost.cost_performance_index < 1.1 ? 'text-yellow-600' : 'text-green-600'}">
                                    ${cost.cost_performance_index.toFixed(2)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusColorClass(status) {
            const colorMap = {
                'red': { text: 'text-red-600', bg: 'bg-red-100' },
                'orange': { text: 'text-orange-600', bg: 'bg-orange-100' },
                'green': { text: 'text-green-600', bg: 'bg-green-100' },
                'blue': { text: 'text-blue-600', bg: 'bg-blue-100' },
                'gray': { text: 'text-gray-600', bg: 'bg-gray-100' }
            };
            return colorMap[status] || colorMap.gray;
        }

        function generateMockCostData(project) {
            // Generate mock data if API is not available
            const disciplines = ['Arquitectura', 'Estructuras', 'Instalaciones Eléctricas', 'Instalaciones Mecánicas', 'Plomería'];
            const disciplineCosts = disciplines.map((name, index) => {
                const projected = Math.round(Math.random() * 50000 + 10000);
                const progress = Math.random() * 100;
                const executed = Math.round(projected * progress / 100);
                const variance = projected - executed;
                const cpi = executed > 0 ? (progress / 100) / (executed / projected) : 0;

                return {
                    discipline_name: name,
                    discipline_code: `DIS${index + 1}`,
                    discipline_color: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][index],
                    projected_cost: projected,
                    executed_cost: executed,
                    labor_cost: Math.round(executed * 0.4),
                    material_cost: Math.round(executed * 0.3),
                    equipment_cost: Math.round(executed * 0.2),
                    subcontractor_cost: Math.round(executed * 0.1),
                    budget_variance: variance,
                    cost_performance_index: cpi,
                    progress_percentage: progress,
                    variance_percentage: (variance / projected) * 100,
                    status_color: variance > 5000 ? 'red' : variance > -2000 ? 'green' : 'blue'
                };
            });

            const totalProjected = disciplineCosts.reduce((sum, cost) => sum + cost.projected_cost, 0);
            const totalExecuted = disciplineCosts.reduce((sum, cost) => sum + cost.executed_cost, 0);

            return {
                discipline_costs: disciplineCosts,
                total_projected: totalProjected,
                total_executed: totalExecuted,
                total_variance: totalProjected - totalExecuted,
                overall_cpi: totalExecuted > 0 ? totalProjected / totalExecuted : 0
            };
        }

        function populateDisciplineModal(project) {
            const contentElement = document.getElementById('disciplineModalContent');
            if (contentElement) {
                contentElement.innerHTML = renderDisciplineProgress(project.disciplines);
            }
        }

        function populateTeamModal(project) {
            const contentElement = document.getElementById('teamModalContent');
            if (contentElement) {
                contentElement.innerHTML = project.team.map(t => `
                    <div class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center text-sm font-bold ring-2 ring-white">${t.initials}</div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-700">${t.name}</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${t.discipline}</span>
                            </div>
                            <span class="text-xs text-gray-500">${t.role}</span>
                        </div>
                    </div>
                `).join('');
            }
        }


        // Render discipline progress for modal
        function renderDisciplineProgress(disciplines) {
            if (!disciplines) {
                // Default disciplines data if not provided
                const defaultDisciplines = [
                    { name: 'Procesos', progress: 95 },
                    { name: 'Mecánica', progress: 88 },
                    { name: 'Eléctrica', progress: 80 },
                    { name: 'I&C', progress: 75 },
                    { name: 'Tuberías', progress: 70 }
                ];
                return defaultDisciplines.map(d => `
                    <div class="mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">${d.name}</span>
                            <span class="text-sm font-bold text-gray-900">${d.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-orange-400 h-2 rounded-full transition-all duration-500" style="width: ${d.progress}%"></div>
                        </div>
                    </div>
                `).join('');
            }
            
            return disciplines.map(d => `
                <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-700">${d.name}</span>
                        <span class="text-sm font-bold text-gray-900">${d.progress}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-orange-400 h-2 rounded-full transition-all duration-500" style="width: ${d.progress}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function renderPendingTasksList(tasks) {
            if (!tasks || tasks.length === 0) {
                return '<div class="text-center py-4 text-gray-500">No hay tareas pendientes</div>';
            }

            const getPriorityColor = (priority) => {
                switch(priority) {
                    case 'Alta': return 'bg-red-100 text-red-800';
                    case 'Media': return 'bg-yellow-100 text-yellow-800';
                    case 'Baja': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const getStatusColor = (status) => {
                switch(status) {
                    case 'En Progreso': return 'bg-blue-100 text-blue-800';
                    case 'Pendiente': return 'bg-gray-100 text-gray-800';
                    case 'Completada': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
            };

            return tasks.map(task => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="text-sm font-semibold text-gray-900 flex-1">${task.title}</h4>
                        <div class="flex space-x-2 ml-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getPriorityColor(task.priority)}">
                                ${task.priority}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(task.status)}">
                                ${task.status}
                            </span>
                        </div>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">${task.description}</p>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <div class="flex items-center space-x-4">
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                ${task.assignee}
                            </span>
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                </svg>
                                ${task.type}
                            </span>
                        </div>
                        <span class="flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            ${formatDate(task.dueDate)}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderDocumentsTable(documents) {
            if (!documents || documents.length === 0) {
                return '<tr><td colspan="10" class="py-4 text-center text-gray-500">No hay documentos registrados</td></tr>';
            }

            const formatDate = (dateString) => {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
            };

            return documents.map((doc, index) => `
                <tr class="border-b hover:bg-gray-50 transition-colors">
                    <td class="py-3 px-2 text-center text-gray-500">${index + 1}</td>
                    <td class="py-3 px-2">
                        <div>
                            <div class="font-mono text-xs text-gray-600">${doc.code}</div>
                            <div class="text-sm font-medium text-gray-900">${doc.name}</div>
                        </div>
                    </td>
                    <td class="py-3 px-2 text-sm text-gray-700">${doc.responsible}</td>
                    <td class="py-3 px-2 text-sm text-gray-700">${doc.discipline || getDisciplineFromCode(doc.code) || '-'}</td>
                    <td class="py-3 px-2 text-center">
                        <span class="${getStatusClass(doc.status)} status-tag text-xs" title="${doc.status}">
                            ${getStatusAbbreviation(doc.status)}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center">
                        <span class="inline-flex items-center justify-center w-6 h-6 bg-gray-100 text-gray-800 text-xs font-bold rounded">
                            ${doc.rev || 'A'}
                        </span>
                    </td>
                    <td class="py-3 px-2 text-center text-sm text-gray-600">${formatDate(doc.fechaEnvio)}</td>
                    <td class="py-3 px-2 text-center text-sm text-gray-600">${formatDate(doc.fechaAprobacion)}</td>
                    <td class="py-3 px-2 text-center text-sm font-semibold text-green-600">$${(doc.cost || 0).toLocaleString()}</td>
                    <td class="py-3 px-2 text-center">
                        <button class="document-actions-btn text-gray-400 hover:text-gray-600 transition-colors" 
                                data-document-id="${doc.code}" 
                                data-document-data='${JSON.stringify(doc)}'
                                title="Ver detalles del documento">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusAbbreviation(status) {
            const abbreviations = {
                'Aprobado': 'APR',
                'Aprobado con Comentarios': 'ACC',
                'Comentado': 'CMN',
                'Rechazado': 'RCH',
                'Aprobado para Construcción': 'APC',
                'Enviado a CDD': 'ECD',
                'Emitido para Revisión': 'EPR',
                'En Revisión': 'ERE',
                'En Elaboración': 'ELB',
                'Para Aprobación': 'PA',
                'Para Revisión Cliente': 'PRC',
                'Revisión Interna': 'RI',
                'Aprobado Internamente': 'AI',
                'Para Aprobación Construcción': 'PAC'
            };
            return abbreviations[status] || status.substring(0, 3).toUpperCase();
        }

        function getDisciplineFromCode(code) {
            const disciplineMap = {
                // Gestión
                '00': 'Gestión',
                '05': 'Gestión',
                // Procesos
                '01': 'Procesos',
                '10': 'Procesos',
                '11': 'Procesos',
                '12': 'Procesos',
                // Mecánica
                '02': 'Mecánico',
                '03': 'Mecánico',
                '20': 'Mecánico',
                '21': 'Mecánico',
                '22': 'Mecánico',
                '23': 'Mecánico',
                '24': 'Mecánico',
                '25': 'Mecánico',
                // Civil
                '30': 'Civil',
                '31': 'Civil',
                '32': 'Civil',
                '33': 'Civil',
                '34': 'Civil',
                '35': 'Civil',
                '36': 'Civil',
                '37': 'Civil',
                '39': 'Civil',
                // Tubería
                '50': 'Tubería',
                '53': 'Tubería',
                '54': 'Tubería',
                '55': 'Tubería',
                '56': 'Tubería',
                '58': 'Tubería',
                '59': 'Tubería',
                // Instrumentación
                '60': 'Instrumentación',
                '61': 'Instrumentación',
                '62': 'Instrumentación',
                '63': 'Instrumentación',
                '64': 'Instrumentación',
                '65': 'Instrumentación',
                '66': 'Instrumentación',
                '67': 'Instrumentación',
                '68': 'Instrumentación',
                '69': 'Instrumentación',
                // Eléctrico
                '04': 'Eléctrico',
                '70': 'Eléctrico',
                '71': 'Eléctrico',
                '72': 'Eléctrico',
                '73': 'Eléctrico',
                '74': 'Eléctrico',
                '75': 'Eléctrico',
                '76': 'Eléctrico',
                '77': 'Eléctrico',
                '78': 'Eléctrico',
                '79': 'Eléctrico',
                // Comunicaciones
                '80': 'Comunicaciones',
                '82': 'Comunicaciones',
                '84': 'Comunicaciones',
                '85': 'Comunicaciones',
                '86': 'Comunicaciones',
                '87': 'Comunicaciones',
                '88': 'Comunicaciones',
                // Skid
                '90': 'Skid',
                // Protección Catódica
                '95': 'Protección Catódica',
                '96': 'Protección Catódica',
                '97': 'Protección Catódica',
                // Gestión
                '00': 'Gestión',
                // Legacy codes
                'PRO': 'Procesos',
                'MEC': 'Mecánica',
                'PIP': 'Piping',
                'ELE': 'Eléctrica',
                'CIV': 'Civil',
                'IC': 'I&C',
                'STR': 'Estructural',
                'INS': 'Instrumentación'
            };
            
            // Extract discipline code from PETROECUADOR document code
            const parts = code.split('-');

            // Check for legacy PETROECUADOR format first: [Proyecto]-[Locación]-[Centro]-[CódigoDisciplina]-... (e.g., B12EY007A-SHY-PCC-70-SLD-001)
            if (parts.length >= 6 && parts[2] === 'PCC') {
                const disciplineCode = parts[3];
                return disciplineMap[disciplineCode] || 'Desconocida';
            }
            // New format: [Proyecto]-[Locación]-[CódigoDisciplina]-[Secuencial]-[Revisión] (e.g., B18PA003A-SHY-70-001-A)
            else if (parts.length >= 5) {
                const disciplineCode = parts[2];
                return disciplineMap[disciplineCode] || 'Desconocida';
            }
            // Simple legacy format (e.g., PA-PRO-PID-001 -> PRO)
            else if (parts.length >= 2) {
                const disciplineCode = parts[1];
                return disciplineMap[disciplineCode] || 'Desconocida';
            }
            return 'Desconocida';
        }

        function setupDocumentSearch(projectId) {
            const searchInput = document.getElementById('documentSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const project = mockData.projects[projectId];
                if (!project || !project.documents) return;

                const filteredDocuments = project.documents.filter(doc => 
                    doc.code.toLowerCase().includes(searchTerm) ||
                    doc.name.toLowerCase().includes(searchTerm) ||
                    doc.responsible.toLowerCase().includes(searchTerm) ||
                    doc.status.toLowerCase().includes(searchTerm)
                );

                const tableBody = document.getElementById('documentsTableBody');
                if (tableBody) {
                    tableBody.innerHTML = renderDocumentsTable(filteredDocuments);
                    setupDocumentActions();
                }
            });
        }

        function setupDocumentActions() {
            document.querySelectorAll('.document-actions-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const documentData = JSON.parse(btn.dataset.documentData);
                    showDocumentDetails(documentData);
                });
            });
        }

        function showDocumentDetails(doc) {
            const modal = document.getElementById('document-details-modal');
            const content = document.getElementById('document-details-content');
            
            const formatDate = (dateString) => {
                if (!dateString) return 'No especificada';
                const date = new Date(dateString);
                return date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                });
            };

            // Generate mock version history for the document following the proper workflow
            const generateVersionHistory = (documentData) => {
                const versions = [];
                const currentRev = documentData.rev;
                
                // Determine the workflow stage based on current revision
                const isLetterRev = /^[A-Z]$/.test(currentRev);
                const isNumberRev = /^[0-9]+$/.test(currentRev);
                
                if (isLetterRev) {
                    // Internal review phase (A, B, C, D, E, F...) - Contractor internal reviews
                    const letterIndex = currentRev.charCodeAt(0) - 65; // A=0, B=1, C=2, etc.
                    
                    for (let i = 0; i <= letterIndex; i++) {
                        const rev = String.fromCharCode(65 + i); // A, B, C, D, E, F...
                        const prevDate = new Date(documentData.date);
                        prevDate.setDate(prevDate.getDate() - (letterIndex - i) * 7); // Mock dates
                        
                        let status, comments, transmittalInfo;
                        if (i === 0) {
                            status = "En Elaboración";
                            comments = "Primera versión - Revisión interna del contratista";
                            transmittalInfo = null;
                        } else if (i === letterIndex && documentData.status === "Enviado a CDD") {
                            status = "Enviado a CDD";
                            comments = "Enviado formalmente a Control de Documentos";
                            const sentDate = new Date(prevDate.getTime() - 1 * 24 * 60 * 60 * 1000);
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(100 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: null
                            };
                        } else if (i === letterIndex && documentData.status === "En Revisión") {
                            status = "Emitido para Revisión";
                            comments = "Emitido por CDD para revisión técnica";
                            const sentDate = new Date(prevDate.getTime() - 1 * 24 * 60 * 60 * 1000);
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(100 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: { code: `B12EY007A-SHY-TR-${String(100 + i).padStart(3, '0')}`, date: prevDate.toISOString().split('T')[0], status: "EPR" }
                            };
                        } else {
                            status = "En Elaboración";
                            comments = `Revisión ${rev} - Incorporando comentarios internos`;
                            transmittalInfo = null;
                        }
                        
                        versions.push({
                            rev: rev,
                            date: prevDate.toISOString().split('T')[0],
                            status: status,
                            sentDate: transmittalInfo?.sent?.date || null,
                            approvedDate: null,
                            responsible: documentData.responsible,
                            cost: Math.round((documentData.cost || 0) * (0.8 + Math.random() * 0.4)), // Cost variation for each version
                            files: [
                                { type: 'pdf', link: '#', name: `${documentData.code}-${rev}.pdf` },
                                { type: i % 2 === 0 ? 'dwg' : 'xlsx', link: '#', name: `${documentData.code}-${rev}.${i % 2 === 0 ? 'dwg' : 'xlsx'}` }
                            ],
                            comments: comments,
                            transmittalInfo: transmittalInfo
                        });
                    }
                } else if (isNumberRev) {
                    // Construction approval phase (0, 1, 2, 3...) - Final approved versions
                    const numRev = parseInt(currentRev);
                    
                    // Add the letter revisions that led to construction approval
                    const letterRevisions = ['A', 'B', 'C', 'D', 'E'];
                    for (let i = 0; i < letterRevisions.length; i++) {
                        const rev = letterRevisions[i];
                        const prevDate = new Date(documentData.date);
                        prevDate.setDate(prevDate.getDate() - (letterRevisions.length - i + numRev) * 7);
                        
                        let status, comments, transmittalInfo;
                        if (i === 0) {
                            status = "En Elaboración";
                            comments = "Primera versión - Revisión interna del contratista";
                            transmittalInfo = null;
                        } else if (i === letterRevisions.length - 1) {
                            status = "Enviado a CDD";
                            comments = "Enviado formalmente a Control de Documentos";
                            const sentDate = new Date(prevDate.getTime() - 1 * 24 * 60 * 60 * 1000);
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(100 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: null
                            };
                        } else {
                            status = "En Elaboración";
                            comments = `Revisión ${rev} - Incorporando comentarios`;
                            transmittalInfo = null;
                        }
                        
                        versions.push({
                            rev: rev,
                            date: prevDate.toISOString().split('T')[0],
                            status: status,
                            sentDate: transmittalInfo?.sent?.date || null,
                            approvedDate: null,
                            responsible: documentData.responsible,
                            cost: Math.round((documentData.cost || 0) * (0.8 + Math.random() * 0.4)),
                            files: [
                                { type: 'pdf', link: '#', name: `${documentData.code}-${rev}.pdf` },
                                { type: i % 2 === 0 ? 'dwg' : 'xlsx', link: '#', name: `${documentData.code}-${rev}.${i % 2 === 0 ? 'dwg' : 'xlsx'}` }
                            ],
                            comments: comments,
                            transmittalInfo: transmittalInfo
                        });
                    }
                    
                    // Add construction approval versions (0, 1, 2, 3...)
                    for (let i = 0; i <= numRev; i++) {
                        const prevDate = new Date(documentData.date);
                        prevDate.setDate(prevDate.getDate() - (numRev - i) * 7);
                        const sentDate = new Date(prevDate.getTime() - 2 * 24 * 60 * 60 * 1000);
                        
                        let status, comments, transmittalInfo;
                        if (i === 0) {
                            status = "Emitido para Revisión";
                            comments = "Emitido por CDD para revisión técnica - Primera versión para construcción";
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: prevDate.toISOString().split('T')[0], status: "EPR" }
                            };
                        } else if (i === numRev && documentData.status === "Aprobado para Construcción") {
                            status = "Aprobado para Construcción";
                            comments = "APROBADO PARA CONSTRUCCIÓN - Documento final";
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: prevDate.toISOString().split('T')[0], status: "APC" }
                            };
                        } else {
                            status = "Comentado";
                            comments = `Revisión ${i} - Comentarios de construcción incorporados`;
                            transmittalInfo = {
                                sent: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: sentDate.toISOString().split('T')[0] },
                                received: { code: `B12EY007A-SHY-TR-${String(200 + i).padStart(3, '0')}`, date: prevDate.toISOString().split('T')[0], status: "CMN" }
                            };
                        }
                        
                        versions.push({
                            rev: i.toString(),
                            date: prevDate.toISOString().split('T')[0],
                            status: status,
                            sentDate: transmittalInfo?.sent?.date || null,
                            approvedDate: i === numRev && documentData.status === "Aprobado" ? prevDate.toISOString().split('T')[0] : null,
                            responsible: documentData.responsible,
                            cost: Math.round((documentData.cost || 0) * (0.85 + Math.random() * 0.3)), // Construction version cost
                            files: [
                                { type: 'pdf', link: '#', name: `${documentData.code}-${i}.pdf` },
                                { type: i % 2 === 0 ? 'dwg' : 'xlsx', link: '#', name: `${documentData.code}-${i}.${i % 2 === 0 ? 'dwg' : 'xlsx'}` }
                            ],
                            comments: comments,
                            transmittalInfo: transmittalInfo
                        });
                    }
                }

                return versions.reverse(); // Show oldest first
            };

            const versionHistory = generateVersionHistory(doc);

            content.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-900 mb-3">Información General</h4>
                        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Código:</span>
                                <div class="font-mono text-gray-900">${doc.code}</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Nombre:</span>
                                <div class="text-gray-900">${doc.name}</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Estado Actual:</span>
                                <div><span class="${getStatusClass(doc.status)} status-tag text-xs">${getStatusAbbreviation(doc.status)}</span></div>
                            </div>
                            <div>
                                <span class="text-gray-500">Responsable:</span>
                                <div class="text-gray-900">${doc.responsible}</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Disciplina:</span>
                                <div class="text-gray-900">${doc.discipline || getDisciplineFromCode(doc.code)}</div>
                            </div>
                            <div>
                                <span class="text-gray-500">Costo Total:</span>
                                <div class="text-gray-900 font-semibold text-green-600">$${(doc.cost || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Historial de Versiones</h4>
                        <div class="space-y-4">
                            ${versionHistory.map((version, index) => `
                                <div class="border border-gray-200 rounded-lg p-4 ${version.rev === doc.rev ? 'bg-blue-50 border-blue-200' : 'bg-white'}">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center space-x-3">
                                            <span class="inline-flex items-center justify-center w-8 h-8 ${version.rev === doc.rev ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'} text-sm font-bold rounded-full">
                                                ${version.rev}
                                            </span>
                                            <div>
                                                <h5 class="font-semibold text-gray-900">Revisión ${version.rev}</h5>
                                                <p class="text-sm text-gray-600">${version.comments}</p>
                                            </div>
                                        </div>
                                        <span class="${getStatusClass(version.status)} status-tag text-xs">${getStatusAbbreviation(version.status)}</span>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 text-sm">
                                        <div>
                                            <span class="text-gray-500">Fecha Emisión:</span>
                                            <div class="text-gray-900">${formatDate(version.date)}</div>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Fecha Envío:</span>
                                            <div class="text-gray-900">${formatDate(version.sentDate)}</div>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Fecha Aprobación:</span>
                                            <div class="text-gray-900">${formatDate(version.approvedDate)}</div>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Costo:</span>
                                            <div class="text-gray-900 font-semibold text-green-600">$${(version.cost || 0).toLocaleString()}</div>
                                        </div>
                                    </div>

                                    ${version.transmittalInfo ? `
                                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                            <h6 class="text-sm font-medium text-gray-700 mb-2">Información de Transmittal:</h6>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                                <div>
                                                    <span class="text-gray-500">Transmittal de Envío:</span>
                                                    <div class="text-gray-900 font-mono">${version.transmittalInfo.sent?.code || 'No enviado'}</div>
                                                    <div class="text-xs text-gray-500">${formatDate(version.transmittalInfo.sent?.date)}</div>
                                                </div>
                                                <div>
                                                    <span class="text-gray-500">Transmittal de Respuesta:</span>
                                                    <div class="text-gray-900 font-mono">${version.transmittalInfo.received?.code || 'Pendiente'}</div>
                                                    <div class="text-xs text-gray-500">${formatDate(version.transmittalInfo.received?.date)}</div>
                                                    ${version.transmittalInfo.received?.status ? `
                                                        <div class="mt-1">
                                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                                                version.transmittalInfo.received.status === 'APC' ? 'bg-green-100 text-green-800' :
                                                                version.transmittalInfo.received.status === 'CMN' ? 'bg-yellow-100 text-yellow-800' :
                                                                'bg-gray-100 text-gray-800'
                                                            }">
                                                                ${version.transmittalInfo.received.status === 'APC' ? 'Aprobado para Construcción' :
                                                                  version.transmittalInfo.received.status === 'CMN' ? 'Con Comentarios' :
                                                                  version.transmittalInfo.received.status}
                                                            </span>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}

                                    <div>
                                        <h6 class="text-sm font-medium text-gray-700 mb-2">Archivos de esta versión:</h6>
                                        <div class="flex flex-wrap gap-2">
                                            ${version.files.map(file => `
                                                <a href="${file.link}" class="flex items-center space-x-2 px-3 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                                    ${getFileIcon(file.type)}
                                                    <span class="text-sm font-medium text-gray-700">${file.name}</span>
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                </a>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Editar Documento
                        </button>
                        <button class="px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-lg hover:opacity-90">
                            Generar Transmittal
                        </button>
                    </div>
                </div>
            `;
            
            openModal(modal);
            
            // Add specific event listener for this modal's close button
            const closeBtn = modal.querySelector('.close-modal-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeModalElement(modal);
                });
            }
        }
        
        function renderRepository(projectId) {
            const p = mockData.projects[projectId];
            if (!p) return;
            repositoryContent.innerHTML = `<div class="bg-white rounded-lg shadow p-4 mb-6"><div class="flex flex-col md:flex-row justify-between items-center"><nav aria-label="breadcrumb"><ol class="flex items-center space-x-2 text-sm"><li><a href="#" class="text-gray-500 hover:text-red-600">${p.name}</a></li><li><span class="text-gray-400">/</span></li><li><span class="font-semibold text-gray-800">Todos los Documentos</span></li></ol></nav><div class="flex space-x-2 mt-4 md:mt-0"><select class="p-2 border rounded-md text-sm"><option>Disciplina: Todas</option></select><select class="p-2 border rounded-md text-sm"><option>Estado: Todos</option></select></div></div></div><div class="bg-gray-100 p-3 rounded-lg mb-6 text-xs text-gray-600"><div class="flex flex-wrap items-center gap-x-4 gap-y-1"><span class="font-semibold">Leyenda:</span><span><strong>APR:</strong> Aprobado</span><span><strong>ACC:</strong> Aprobado con Com.</span><span><strong>PA:</strong> Para Aprobación</span><span><strong>PRC:</strong> Para Rev. Cliente</span><span><strong>RI:</strong> Rev. Interna</span><span><strong>AI:</strong> Aprob. Internamente</span><span><strong>REC:</strong> Rechazado</span></div></div><div class="bg-white rounded-lg shadow overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-gray-100 border-b halli-light-border"><tr><th class="p-3 font-semibold text-center">Ítem</th><th class="p-3 font-semibold">Código</th><th class="p-3 font-semibold">Descripción</th><th class="p-3 font-semibold text-center">Rev.</th><th class="p-3 font-semibold text-center">Estado</th><th class="p-3 font-semibold">Fecha Emisión</th><th class="p-3 font-semibold">Responsable</th><th class="p-3 font-semibold">Archivos</th><th class="p-3 font-semibold"></th></tr></thead><tbody>${p.documents.map((d,i)=>`<tr class="border-b halli-light-border hover:bg-gray-50"><td class="p-3 text-center">${i+1}</td><td class="p-3 font-mono text-sm halli-medium-text">${d.code}</td><td class="p-3">${d.name}</td><td class="p-3 text-center font-semibold">${d.rev}</td><td class="p-3 text-center"><span class="${getStatusClass(d.status)} status-tag" title="${d.status}">${statusMap[d.status] || d.status}</span></td><td class="p-3">${d.date}</td><td class="p-3 halli-medium-text">${d.responsible}</td><td class="p-3"><div class="flex items-center justify-center space-x-2">${d.files.map(f => `<a href="${f.link}" title="${f.type.toUpperCase()}" class="hover:opacity-75">${getFileIcon(f.type)}</a>`).join('')}</div></td><td class="p-3 text-center"><button class="text-gray-500 hover:text-red-600">...</button></td></tr>`).join('')}</tbody></table></div>`;
        }

        function renderTransmittalList() {
            transmittalsContent.innerHTML = `<div id="transmittal-list-view" class="bg-white rounded-lg shadow p-4"><div class="border-b mb-4"><nav class="flex space-x-4" id="transmittal-tabs"><button data-tab="outbox" class="tab-btn py-2 px-4 font-semibold border-b-2">Bandeja de Salida</button><button data-tab="inbox" class="tab-btn py-2 px-4 font-semibold border-b-2">Bandeja de Entrada</button></nav></div><div id="outbox-tab" class="tab-content"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr class="bg-gray-50"><th class="p-3 font-semibold">Código</th><th class="p-3 font-semibold">Asunto</th><th class="p-3 font-semibold">Para</th><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold">Estado</th></tr></thead><tbody>${mockData.transmittals.filter(t=>t.type==='out').map(t=>`<tr data-id="${t.id}" class="transmittal-row border-b hover:bg-gray-50 cursor-pointer"><td class="p-3 font-semibold halli-dark-text">${t.code}</td><td class="p-3">${t.purpose}</td><td class="p-3">${t.to}</td><td class="p-3">${t.date}</td><td class="p-3"><span class="status-tag bg-blue-100 text-blue-800">${t.status}</span></td></tr>`).join('')}</tbody></table></div></div><div id="inbox-tab" class="tab-content hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr class="bg-gray-50"><th class="p-3 font-semibold">Código</th><th class="p-3 font-semibold">Asunto</th><th class="p-3 font-semibold">De</th><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold">Estado</th></tr></thead><tbody>${mockData.transmittals.filter(t=>t.type==='in').map(t=>`<tr data-id="${t.id}" class="transmittal-row border-b hover:bg-gray-50 cursor-pointer"><td class="p-3 font-semibold halli-dark-text">${t.code}</td><td class="p-3">${t.purpose}</td><td class="p-3">${t.from}</td><td class="p-3">${t.date}</td><td class="p-3"><span class="status-tag bg-green-100 text-green-800">${t.status}</span></td></tr>`).join('')}</tbody></table></div></div></div>`;
            document.getElementById('transmittal-tabs').addEventListener('click', (e) => { if (e.target.classList.contains('tab-btn')) { const tabId=e.target.dataset.tab; document.querySelectorAll('#transmittals-content .tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById(`${tabId}-tab`).classList.remove('hidden'); document.querySelectorAll('#transmittal-tabs .tab-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); }});
            document.querySelector('#transmittal-tabs .tab-btn').click();
            document.querySelectorAll('.transmittal-row').forEach(row => row.addEventListener('click', () => renderTransmittalDetail(row.dataset.id)));
        }

        function renderTransmittalDetail(id) {
            const t = mockData.transmittals.find(tr => tr.id == id);
            transmittalsContent.innerHTML = `<button id="back-to-transmittals-btn" class="text-sm text-red-600 font-semibold flex items-center mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Volver a la lista</button><div class="bg-white rounded-lg shadow p-8 border"><div class="flex justify-between items-start mb-6"><h3 class="text-2xl font-bold">Transmittal</h3><div class="text-right"><p class="font-bold text-lg">${t.code}</p><p class="text-sm text-gray-500">Fecha: ${t.date}</p></div></div><div class="grid grid-cols-2 gap-6 border-y py-4 mb-6 text-sm"><div class="space-y-2"><p><strong>De:</strong> ${t.from}</p><p><strong>Para:</strong> ${t.to}</p><p><strong>Atención:</strong> ${t.attn}</p></div><div class="space-y-2"><p><strong>Proyecto:</strong> ${t.project}</p><p><strong>Método de Envío:</strong> ${t.method}</p></div></div><div class="mb-6"><p class="font-semibold mb-2">Propósito del Envío:</p><span class="bg-gray-100 text-gray-800 text-sm font-medium mr-2 px-2.5 py-0.5 rounded">${t.purpose}</span></div><div class="mb-6"><p class="font-semibold mb-2">Listado de Documentos:</p><div class="overflow-x-auto border rounded-lg"><table class="w-full text-left text-sm"><thead><tr class="bg-gray-50"><th class="p-2">Ítem</th><th class="p-2">Código</th><th class="p-2">Descripción</th><th class="p-2 text-center">Revisión</th></tr></thead><tbody>${t.documents.map(d => `<tr class="border-t"><td class="p-2">${d.item}</td><td class="p-2 font-mono">${d.code}</td><td class="p-2">${d.description}</td><td class="p-2 text-center">${d.rev}</td></tr>`).join('')}</tbody></table></div></div><div class="mb-6"><p class="font-semibold">Comentarios:</p><p class="text-sm text-gray-600 mt-1 p-3 border rounded-lg bg-gray-50">${t.comments}</p></div><div class="grid grid-cols-3 gap-6 text-center text-sm pt-6 border-t"><div class="space-y-2"><p class="font-semibold">${t.preparedBy}</p><hr><p>Preparado Por</p></div><div></div><div class="self-end"><hr><p>Recibido Por</p></div></div></div>`;
            document.getElementById('back-to-transmittals-btn').addEventListener('click', renderTransmittalList);
        }

        function renderReports() {
            reportsContent.innerHTML = `
                <div class="space-y-8">
                    <section>
                        <h3 class="text-xl font-semibold mb-4 halli-dark-text">Reportes Predefinidos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer" onclick="showCostProgressChart()">
                                <h4 class="font-bold text-lg">Gráfico de Avance en Costo</h4>
                                <p class="text-sm text-gray-600 mt-2">Visualiza el avance de costos proyectados vs reales acumulados por mes.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
                                <h4 class="font-bold text-lg">Lista Maestra de Documentos</h4>
                                <p class="text-sm text-gray-600 mt-2">Exporta el MDL completo del proyecto seleccionado en formato Excel.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
                                <h4 class="font-bold text-lg">Reporte de Documentos Atrasados</h4>
                                <p class="text-sm text-gray-600 mt-2">Genera una lista de todos los entregables que no cumplieron su fecha planificada.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
                                <h4 class="font-bold text-lg">Curva S de Avance</h4>
                                <p class="text-sm text-gray-600 mt-2">Visualiza el avance documental planificado vs. el real a lo largo del tiempo.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
                                <h4 class="font-bold text-lg">Reporte Mensual de Avance</h4>
                                <p class="text-sm text-gray-600 mt-2">Genera un reporte detallado del progreso mensual del proyecto con métricas de avance.</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-lg transition-shadow cursor-pointer">
                                <h4 class="font-bold text-lg">Reporte Semanal de Avance</h4>
                                <p class="text-sm text-gray-600 mt-2">Reporte semanal con estadísticas de avance, tareas completadas y pendientes.</p>
                            </div>
                        </div>
                    </section>
                    
                    <section id="cost-progress-section" class="hidden">
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-semibold halli-dark-text">Gráfico de Avance en Costo</h3>
                                <button onclick="hideCostProgressChart()" class="text-gray-400 hover:text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="mb-4">
                                <div class="flex items-center space-x-6">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-blue-500"></div>
                                        <span class="text-sm font-medium">Proyectado Acumulado</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-4 h-4 bg-red-500"></div>
                                        <span class="text-sm font-medium">Real Acumulado</span>
                                    </div>
                                </div>
                            </div>
                            <div class="h-96">
                                <canvas id="costProgressChart"></canvas>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h3 class="text-xl font-semibold mb-4 halli-dark-text">Generador de Reportes Personalizados</h3>
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div><label class="text-sm font-medium">Proyecto</label><select class="w-full p-2 mt-1 border rounded-md"><option>Palo Azul - Fase II</option></select></div>
                                <div><label class="text-sm font-medium">Rango de Fechas</label><input type="date" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="self-end"><button class="w-full px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-lg shadow-sm hover:opacity-90">Generar Reporte</button></div>
                            </div>
                        </div>
                    </section>
                </div>
            `;
        }

        function renderSettings() {
            settingsContent.innerHTML = `<div class="bg-white rounded-lg shadow"><div class="border-b"><nav class="flex space-x-4 p-4" id="settings-tabs"><button data-tab="users" class="tab-btn py-2 px-4 font-semibold border-b-2">Gestión de Usuarios</button><button data-tab="projects" class="tab-btn py-2 px-4 font-semibold border-b-2">Proyectos</button><button data-tab="standards" class="tab-btn py-2 px-4 font-semibold border-b-2">Estándares</button></nav></div><div class="p-6"><div id="users-tab" class="tab-content">${renderUsersTable()}</div><div id="projects-tab" class="tab-content hidden"><h4 class="text-lg font-semibold">Configuración de Proyectos</h4><p>Aquí se configurarían los detalles del proyecto.</p></div><div id="standards-tab" class="tab-content hidden"><h4 class="text-lg font-semibold">Estándares y Plantillas</h4><p>Aquí se definirían las plantillas y reglas de codificación.</p></div></div></div>`;
            document.getElementById('settings-tabs').addEventListener('click', (e) => { if (e.target.classList.contains('tab-btn')) { const tabId=e.target.dataset.tab; document.querySelectorAll('#settings-content .tab-content').forEach(c=>c.classList.add('hidden')); document.getElementById(`${tabId}-tab`).classList.remove('hidden'); document.querySelectorAll('#settings-tabs .tab-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); }});
            document.querySelector('#settings-tabs .tab-btn').click();
        }

        function renderUsersTable() {
            const usersHTML = mockData.users.map(u => `<tr class="border-b halli-light-border"><td class="p-3 font-semibold">${u.name}</td><td class="p-3">${u.email}</td><td class="p-3">${u.role}</td><td class="p-3">${u.project}</td><td class="p-3 text-center"><button class="text-gray-500 hover:text-red-600">...</button></td></tr>`).join('');
            return `<div class="flex justify-between items-center mb-4"><h4 class="text-lg font-semibold">Usuarios del Sistema</h4><button class="px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-lg shadow-sm hover:opacity-90">Añadir Usuario</button></div><div class="overflow-x-auto border rounded-lg"><table class="w-full text-left text-sm"><thead class="bg-gray-100"><tr><th class="p-3 font-semibold">Nombre</th><th class="p-3 font-semibold">Correo</th><th class="p-3 font-semibold">Rol</th><th class="p-3 font-semibold">Proyecto Asignado</th><th></th></tr></thead><tbody>${usersHTML}</tbody></table></div>`;
        }

        // Make functions global for onclick handlers
        window.switchChartTab = switchChartTab;
        window.showAddDocumentModal = showAddDocumentModal;
        window.closeAddDocumentModal = closeAddDocumentModal;
        window.showUploadDocModal = showUploadDocModal;
        window.closeUploadDocModal = closeUploadDocModal;
        window.generateDocumentCodeUpload = generateDocumentCodeUpload;
        window.autoGenerateCodeUpload = autoGenerateCodeUpload;
        window.onDisciplineChangeUpload = onDisciplineChangeUpload;
        window.checkAndAutoGenerateUpload = checkAndAutoGenerateUpload;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.generateDocumentCode = generateDocumentCode;
        window.autoGenerateCode = autoGenerateCode;
        window.showRecentActivityModal = showRecentActivityModal;
        window.closeRecentActivityModal = closeRecentActivityModal;
        window.checkAndAutoGenerate = checkAndAutoGenerate;
        window.onDisciplineChange = onDisciplineChange;
        
        // Document Code Generator Function
        function generateDocumentCode() {
            const projectInput = document.getElementById('doc-project');
            const locationInput = document.getElementById('doc-location');
            const disciplineTypeSelect = document.getElementById('doc-discipline-type');
            const sequenceInput = document.getElementById('doc-sequence');
            const codeInput = document.getElementById('doc-code');

            if (!projectInput || !locationInput || !disciplineTypeSelect || !sequenceInput || !codeInput) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDisciplineType = disciplineTypeSelect.value;

            if (!project || !location || !selectedDisciplineType) {
                codeInput.value = '';
                return;
            }

            // Auto-suggest next sequence number if not manually set
            let sequence = parseInt(sequenceInput.value) || 1;
            if (!sequenceInput.value || sequenceInput.value === '1') {
                const suggestedSequence = suggestNextSequence(selectedDisciplineType);
                sequenceInput.value = suggestedSequence;
                sequence = suggestedSequence;
            }

            // PETROECUADOR format: [Proyecto]-[Locación]-[Código de Disciplina]-[No. Secuencial]-[Revisión]
            // Example: B18PA003A-SHY-70-001-A
            const sequenceFormatted = String(sequence).padStart ? String(sequence).padStart(3, '0') : ('000' + sequence).slice(-3);
            const revision = 'A'; // Default revision

            const generatedCode = `${project}-${location}-${selectedDisciplineType}-${sequenceFormatted}-${revision}`;
            codeInput.value = generatedCode;
        }
        
        function autoGenerateCode() {
            const projectInput = document.getElementById('doc-project');
            const locationInput = document.getElementById('doc-location');
            const disciplineSelect = document.getElementById('doc-discipline');
            const disciplineTypeSelect = document.getElementById('doc-discipline-type');

            if (!projectInput || !locationInput || !disciplineSelect || !disciplineTypeSelect) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDiscipline = disciplineSelect.value;
            const selectedDisciplineType = disciplineTypeSelect.value;

            if (!project || !location || !selectedDiscipline || !selectedDisciplineType) {
                showNotification('Por favor complete proyecto, locación, disciplina y tipo de plano primero', 'error');
                return;
            }

            // Auto-suggest next sequence number
            const suggestedSequence = suggestNextSequence(selectedDisciplineType);
            document.getElementById('doc-sequence').value = suggestedSequence;

            // Generate the code
            generateDocumentCode();

            showNotification('Código generado automáticamente', 'success');
        }
        
        // Discipline types data structure
        const disciplineTypes = {
            "Procesos": [
                { name: "Diagrama de Procesos e Instrumentación", code: "01" },
                { name: "Diagrama de Flujo de Procesos", code: "11" },
                { name: "Diagrama de Balance de Masas", code: "12" }
            ],
            "Mecánica": [
                { name: "Mecánico General", code: "20" },
                { name: "Recipientes", code: "21" },
                { name: "Tanques", code: "22" },
                { name: "Intercambiador de Calor", code: "23" },
                { name: "Calentadores", code: "24" },
                { name: "Equipo Rotativo", code: "25" }
            ],
            "Civil": [
                { name: "Civil General", code: "30" },
                { name: "Topografía", code: "31" },
                { name: "Cimentaciones", code: "32" },
                { name: "Estructuras de Hormigón", code: "33" },
                { name: "Estructuras de Acero", code: "34" },
                { name: "Arquitectura", code: "35" },
                { name: "Diseño Vial", code: "36" },
                { name: "Instalaciones Sanitarias", code: "37" },
                { name: "Sistema de Información Geográfica", code: "39" }
            ],
            "Tubería": [
                { name: "Tubería General", code: "50" },
                { name: "Isométricos", code: "53" },
                { name: "Detalle de Tubería", code: "54" },
                { name: "Arreglo de Tubería", code: "55" },
                { name: "Soportes", code: "56" },
                { name: "Planos de Ruta de Oleoducto", code: "58" },
                { name: "Planos de Detalle de Oleoducto", code: "59" }
            ],
            "Instrumentación": [
                { name: "Instrumentación General", code: "60" },
                { name: "Matriz Causa y Efecto", code: "61" },
                { name: "Planos de Ubicación de Instrumentos", code: "62" },
                { name: "Diagramas de Lazo", code: "63" },
                { name: "Diagrama de Cableado de Instrumentación", code: "64" },
                { name: "Panel de Control", code: "65" },
                { name: "Hook-up de Instrumentos", code: "66" },
                { name: "Ruteo de Cables y Bandejas", code: "67" },
                { name: "Diagrama de Bloque", code: "68" },
                { name: "Diagramas Lógicos", code: "69" }
            ],
            "Eléctrica": [
                { name: "Eléctrico General", code: "70" },
                { name: "Planos de Planta de Equipos Eléctricos", code: "71" },
                { name: "Diagramas de Clasificación de Área", code: "72" },
                { name: "Diagramas de Potencia", code: "73" },
                { name: "Diagramas de Iluminación", code: "74" },
                { name: "Diagramas de Cableado", code: "75" },
                { name: "Conexiones a Tierra", code: "76" },
                { name: "Detalle de Instalación Eléctrica", code: "77" },
                { name: "Ruteo de Cable Eléctrico", code: "78" },
                { name: "Diagramas Unifilares", code: "79" }
            ],
            "Comunicaciones": [
                { name: "Comunicaciones General", code: "80" },
                { name: "Planos de ubicación de dispositivos", code: "82" },
                { name: "Diagrama de conexionado", code: "84" },
                { name: "Paneles/Racks de comunicaciones", code: "85" },
                { name: "Hook-up de Componentes", code: "86" },
                { name: "Ruteo de cables y detalles", code: "87" },
                { name: "Diagrama de bloque / arquitecturas", code: "88" }
            ],
            "Skid": [
                { name: "Skid Planos generales", code: "90" }
            ],
            "Protección Catódica": [
                { name: "Protección Catódica General", code: "95" },
                { name: "Diagrama de Instalaciones Generales", code: "96" },
                { name: "Diagrama de Instalaciones Detallados", code: "97" }
            ],
            "Gestión": [
                { name: "Gestión General", code: "00" },
                { name: "Listado Master Documentos", code: "05" }
            ]
        };

        function onDisciplineChange() {
            const disciplineSelect = document.getElementById('doc-discipline');
            const disciplineTypeSelect = document.getElementById('doc-discipline-type');

            const selectedDiscipline = disciplineSelect.value;

            // Clear current options
            disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';

            if (selectedDiscipline && disciplineTypes[selectedDiscipline]) {
                // Enable the type select
                disciplineTypeSelect.disabled = false;

                // Add options for the selected discipline
                disciplineTypes[selectedDiscipline].forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.code;
                    option.textContent = `${type.code} - ${type.name}`;
                    option.setAttribute('data-code', type.code);
                    disciplineTypeSelect.appendChild(option);
                });
            } else {
                // Disable if no discipline selected
                disciplineTypeSelect.disabled = true;
            }

            // Clear code when discipline changes
            document.getElementById('doc-code').value = '';
        }

        function checkAndAutoGenerate() {
            const projectInput = document.getElementById('doc-project');
            const locationInput = document.getElementById('doc-location');
            const disciplineSelect = document.getElementById('doc-discipline');
            const disciplineTypeSelect = document.getElementById('doc-discipline-type');

            if (!projectInput || !locationInput || !disciplineSelect || !disciplineTypeSelect) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDiscipline = disciplineSelect.value;
            const selectedDisciplineType = disciplineTypeSelect.value;

            // Auto-generate code when project, location, discipline and discipline type are selected
            if (project && location && selectedDiscipline && selectedDisciplineType) {
                autoGenerateCode();
            }
        }
        
        function getCurrentProjectPrefix() {
            // Try to get project prefix from current project data
            const currentProjectId = getCurrentProjectId();
            if (currentProjectId && mockData.projects[currentProjectId]) {
                const project = mockData.projects[currentProjectId];
                // Extract prefix from existing documents or use project-specific prefix
                if (project.documents && project.documents.length > 0) {
                    const existingCode = project.documents[0].code;
                    if (existingCode) {
                        // Extract prefix from existing code (e.g., "B12EY007A-SHY-PCC" from "B12EY007A-SHY-PCC-70-SLD-001")
                        const parts = existingCode.split('-');
                        if (parts.length >= 3) {
                            return parts.slice(0, 3).join('-');
                        }
                    }
                }
            }
            
            // Default prefix for new projects
            return 'B12EY007A-SHY-PCC';
        }
        
        function suggestNextSequence(disciplineCode) {
            const currentProjectId = getCurrentProjectId();
            if (!currentProjectId || !mockData.projects[currentProjectId]) {
                return 1;
            }
            
            const project = mockData.projects[currentProjectId];
            
            // Find existing documents with same discipline code
            const existingSequences = [];
            
            if (project.documents) {
                project.documents.forEach(doc => {
                    if (doc.code) {
                        const parts = doc.code.split('-');
                        if (parts.length >= 5) {
                            const docDiscipline = parts[2]; // Discipline is now at position 2
                            const sequence = parseInt(parts[3]); // Sequence is now at position 3
                            
                            if (docDiscipline === disciplineCode && !isNaN(sequence)) {
                                existingSequences.push(sequence);
                            }
                        }
                    }
                });
            }
            
            // Return next available sequence number
            if (existingSequences.length === 0) {
                return 1;
            }
            
            const maxSequence = Math.max(...existingSequences);
            return maxSequence + 1;
        }
        
        // Add Document Modal Functions
        function showAddDocumentModal() {
            const modal = document.getElementById('add-document-modal');
            if (modal) {
                modal.classList.remove('hidden');

                // Reset discipline type select
                const disciplineTypeSelect = document.getElementById('doc-discipline-type');
                disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';
                disciplineTypeSelect.disabled = true;

                // Set default values based on current project
                const currentProjectId = getCurrentProjectId();
                if (currentProjectId && mockData.projects[currentProjectId]) {
                    const project = mockData.projects[currentProjectId];

                    // Extract project prefix from existing documents
                    if (project.documents && project.documents.length > 0) {
                        const existingCode = project.documents[0].code;
                        if (existingCode) {
                            const parts = existingCode.split('-');
                            if (parts.length >= 2) {
                                document.getElementById('doc-project').value = parts[0];
                                document.getElementById('doc-location').value = parts[1];
                            }
                        }
                    }
                }

                // Focus on the first input field
                document.getElementById('doc-project').focus();
            }
        }

        function closeAddDocumentModal() {
            const modal = document.getElementById('add-document-modal');
            if (modal) {
                modal.classList.add('hidden');
                // Reset form
                document.getElementById('add-document-form').reset();

                // Reset discipline type select
                const disciplineTypeSelect = document.getElementById('doc-discipline-type');
                disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';
                disciplineTypeSelect.disabled = true;
            }
            // Also hide the backdrop
            if (modalBackdrop) {
                modalBackdrop.classList.add('hidden');
            }
        }

        // Upload Document Modal Functions
        function showUploadDocModal() {
            const modal = document.getElementById('upload-doc-modal');
            if (modal) {
                modal.classList.remove('hidden');

                // Reset discipline type select
                const disciplineTypeSelect = document.getElementById('upload-discipline-type');
                disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';
                disciplineTypeSelect.disabled = true;

                // Set default values based on current project
                const currentProjectId = getCurrentProjectId();
                if (currentProjectId && mockData.projects[currentProjectId]) {
                    const project = mockData.projects[currentProjectId];

                    // Extract project prefix from existing documents
                    if (project.documents && project.documents.length > 0) {
                        const existingCode = project.documents[0].code;
                        if (existingCode) {
                            const parts = existingCode.split('-');
                            if (parts.length >= 2) {
                                const projectPrefix = parts[0];
                                document.getElementById('upload-project').value = projectPrefix;
                            }
                        }
                    }
                }

                // Focus on the first input field
                document.getElementById('upload-project').focus();
            }
        }

        function closeUploadDocModal() {
            const modal = document.getElementById('upload-doc-modal');
            if (modal) {
                modal.classList.add('hidden');
                // Reset form
                document.getElementById('upload-doc-form').reset();

                // Reset discipline type select
                const disciplineTypeSelect = document.getElementById('upload-discipline-type');
                disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';
                disciplineTypeSelect.disabled = true;
            }
            // Also hide the backdrop
            if (modalBackdrop) {
                modalBackdrop.classList.add('hidden');
            }
        }

        function generateDocumentCodeUpload() {
            const projectInput = document.getElementById('upload-project');
            const locationInput = document.getElementById('upload-location');
            const disciplineTypeSelect = document.getElementById('upload-discipline-type');
            const sequenceInput = document.getElementById('upload-sequence');
            const codeInput = document.getElementById('upload-code');

            if (!projectInput || !locationInput || !disciplineTypeSelect || !sequenceInput || !codeInput) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDisciplineType = disciplineTypeSelect.value;

            if (!project || !location || !selectedDisciplineType) {
                codeInput.value = '';
                return;
            }

            // Auto-suggest next sequence number if not manually set
            let sequence = parseInt(sequenceInput.value) || 1;
            if (!sequenceInput.value || sequenceInput.value === '1') {
                const suggestedSequence = suggestNextSequence(selectedDisciplineType);
                sequenceInput.value = suggestedSequence;
                sequence = suggestedSequence;
            }

            // PETROECUADOR format: [Proyecto]-[Locación]-[Código de Disciplina]-[No. Secuencial]-[Revisión]
            // Example: B18PA003A-SHY-70-001-A
            const sequenceFormatted = String(sequence).padStart ? String(sequence).padStart(3, '0') : ('000' + sequence).slice(-3);
            const revision = 'A'; // Default revision

            const generatedCode = `${project}-${location}-${selectedDisciplineType}-${sequenceFormatted}-${revision}`;
            codeInput.value = generatedCode;
        }

        function autoGenerateCodeUpload() {
            const projectInput = document.getElementById('upload-project');
            const locationInput = document.getElementById('upload-location');
            const disciplineSelect = document.getElementById('upload-discipline');
            const disciplineTypeSelect = document.getElementById('upload-discipline-type');

            if (!projectInput || !locationInput || !disciplineSelect || !disciplineTypeSelect) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDiscipline = disciplineSelect.value;
            const selectedDisciplineType = disciplineTypeSelect.value;

            if (!project || !location || !selectedDiscipline || !selectedDisciplineType) {
                showNotification('Por favor complete proyecto, locación, disciplina y tipo de plano primero', 'error');
                return;
            }

            // Auto-suggest next sequence number
            const suggestedSequence = suggestNextSequence(selectedDisciplineType);
            document.getElementById('upload-sequence').value = suggestedSequence;

            // Generate the code
            generateDocumentCodeUpload();

            showNotification('Código generado automáticamente', 'success');
        }

        function onDisciplineChangeUpload() {
            const disciplineSelect = document.getElementById('upload-discipline');
            const disciplineTypeSelect = document.getElementById('upload-discipline-type');

            const selectedDiscipline = disciplineSelect.value;

            // Clear current options
            disciplineTypeSelect.innerHTML = '<option value="">Seleccionar tipo de plano...</option>';

            if (selectedDiscipline && disciplineTypes[selectedDiscipline]) {
                // Enable the type select
                disciplineTypeSelect.disabled = false;

                // Add options for the selected discipline
                disciplineTypes[selectedDiscipline].forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.code;
                    option.textContent = `${type.code} - ${type.name}`;
                    option.setAttribute('data-code', type.code);
                    disciplineTypeSelect.appendChild(option);
                });
            } else {
                // Disable if no discipline selected
                disciplineTypeSelect.disabled = true;
            }

            // Clear code when discipline changes
            document.getElementById('upload-code').value = '';
        }

        function checkAndAutoGenerateUpload() {
            const projectInput = document.getElementById('upload-project');
            const locationInput = document.getElementById('upload-location');
            const disciplineSelect = document.getElementById('upload-discipline');
            const disciplineTypeSelect = document.getElementById('upload-discipline-type');

            if (!projectInput || !locationInput || !disciplineSelect || !disciplineTypeSelect) {
                return;
            }

            const project = projectInput.value.trim();
            const location = locationInput.value.trim();
            const selectedDiscipline = disciplineSelect.value;
            const selectedDisciplineType = disciplineTypeSelect.value;

            // Auto-generate code when project, location, discipline and discipline type are selected
            if (project && location && selectedDiscipline && selectedDisciplineType) {
                autoGenerateCodeUpload();
            }
        }

        function closeUserProfileModal() {
            closeModal('user-profile-modal');
        }

        function showRecentActivityModal(projectId) {
            const modal = document.getElementById('recent-activity-modal');
            const content = document.getElementById('recent-activity-content');

            if (!projectId || projectId === 'undefined') {
                console.warn('Project ID is undefined, trying to get it from dashboard content');
                const dashboardContent = document.getElementById('dashboard-content');
                projectId = dashboardContent ? dashboardContent.dataset.projectId : null;
            }

            if (modal && content && projectId && mockData.projects[projectId]) {
                const project = mockData.projects[projectId];
                const activities = project.recentActivity || [];

                // Header con información del proyecto
                const projectInfo = `
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                            Información del Proyecto
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="space-y-2">
                                <div><strong class="text-gray-700">Nombre:</strong> <span class="text-gray-900">${project.name}</span></div>
                                <div><strong class="text-gray-700">Ubicación:</strong> <span class="text-gray-900">${project.location}</span></div>
                                <div><strong class="text-gray-700">Líder del Proyecto:</strong> <span class="text-gray-900">${project.manager}</span></div>
                            </div>
                            <div class="space-y-2">
                                <div><strong class="text-gray-700">Estado:</strong> <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${project.status === 'En Ejecución' ? 'bg-green-100 text-green-800' : project.status === 'Completado' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${project.status}</span></div>
                                <div><strong class="text-gray-700">Avance General:</strong> <span class="text-gray-900 font-semibold">${project.overallProgress}%</span></div>
                                <div><strong class="text-gray-700">Ciclo Time Promedio:</strong> <span class="text-gray-900">${project.kpis.cycleTime}</span></div>
                            </div>
                        </div>
                    </div>
                `;

                const activitiesHTML = activities.map((a, index) => `
                    <li class="flex items-start space-x-3 pb-4 border-b border-gray-100 last:border-b-0 last:pb-0 hover:bg-gray-50 rounded-lg p-2 transition-colors">
                        <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-sm halli-medium-text flex-shrink-0 border-2 border-white shadow-sm">
                            ${a.user.substring(0, 1)}.
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-sm leading-relaxed">
                                        <span class="font-semibold text-gray-900">${a.user}</span>
                                        <span class="text-gray-700">${a.action}</span>
                                        <span class="font-semibold text-red-600 bg-red-50 px-2 py-1 rounded text-xs">${a.docCode}</span>
                                    </p>
                                    <div class="flex items-center space-x-4 mt-2">
                                        <p class="text-xs text-gray-500 flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            ${a.time}
                                        </p>
                                        <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full font-medium">
                                            #${index + 1}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                `).join('');

                const totalActivities = activities.length;
                const summaryInfo = `
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                </svg>
                                <span class="text-sm font-semibold text-blue-800">Resumen de Actividad</span>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                ${totalActivities} ${totalActivities === 1 ? 'actividad' : 'actividades'}
                            </span>
                        </div>
                        <p class="text-sm text-blue-700 mt-2">
                            Mostrando el historial completo de actividades recientes del proyecto. Cada actividad está numerada para facilitar el seguimiento.
                        </p>
                    </div>
                `;

                content.innerHTML = projectInfo +
                    (activities.length > 0 ? `<ul class="space-y-1">${activitiesHTML}</ul>${summaryInfo}` :
                    '<div class="text-center py-12"><svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><p class="text-gray-500 text-lg font-medium mt-4">No hay actividad reciente</p><p class="text-gray-400 text-sm mt-2">Este proyecto aún no tiene actividades registradas.</p></div>');

                modal.classList.remove('hidden');
                if (modalBackdrop) {
                    modalBackdrop.classList.remove('hidden');
                }
            } else {
                console.error('No se pudo mostrar el modal de actividad reciente: projectId inválido o no encontrado', { projectId, availableProjects: Object.keys(mockData.projects) });
                alert('Error: No se pudo cargar la información del proyecto. Verifique que haya seleccionado un proyecto válido.');
            }
        }

        function closeRecentActivityModal() {
            const modal = document.getElementById('recent-activity-modal');
            if (modal) {
                modal.classList.add('hidden');
                if (modalBackdrop) {
                    modalBackdrop.classList.add('hidden');
                }
            }
        }

        function editProfile() {
            // Placeholder for edit profile functionality
            alert('Funcionalidad de edición de perfil próximamente disponible');
        }

        function addDocumentToProject(projectId, newDocument) {
            if (mockData.projects[projectId] && mockData.projects[projectId].documents) {
                // Add files array if not provided
                if (!newDocument.files) {
                    newDocument.files = [
                        { type: 'pdf', link: '#', name: `${newDocument.code}-${newDocument.rev}.pdf` }
                    ];
                }
                
                // Add the new document to the beginning of the array
                mockData.projects[projectId].documents.unshift(newDocument);
                
                // Refresh the dashboard if we're currently viewing this project
                const currentProject = document.querySelector('.project-card[data-project-id="' + projectId + '"]');
                if (currentProject) {
                    renderDashboard(projectId);
                }
                
                return true;
            }
            return false;
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const addDocumentForm = document.getElementById('add-document-form');
            if (addDocumentForm) {
                addDocumentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Basic validation
                    const code = document.getElementById('doc-code').value.trim();
                    const name = document.getElementById('doc-name').value.trim();
                    const responsible = document.getElementById('doc-responsible').value.trim();
                    const project = document.getElementById('doc-project').value.trim();
                    const location = document.getElementById('doc-location').value.trim();
                    const discipline = document.getElementById('doc-discipline').value;
                    const disciplineType = document.getElementById('doc-discipline-type').value;

                    if (!code || !name || !responsible || !project || !location || !discipline || !disciplineType) {
                        showNotification('Por favor complete todos los campos requeridos y genere el código', 'error');
                        return;
                    }
                    
                    // Get form data
                    const formData = new FormData(addDocumentForm);
                    const newDocument = {
                        name: formData.get('name'),
                        code: formData.get('code'),
                        rev: 'A', // Default revision
                        date: null, // No date by default
                        status: 'En Elaboración', // Default status
                        responsible: formData.get('responsible'),
                        discipline: getDisciplineFromCode(formData.get('code')),
                        fechaEnvio: null, // No date by default
                        fechaAprobacion: null, // No date by default
                        cost: 0, // Default cost
                        files: [
                            { type: 'pdf', link: '#', name: `${formData.get('code')}-A.pdf` }
                        ]
                    };
                    
                    // Get current project ID (assuming we're in dashboard view)
                    const currentProjectId = getCurrentProjectId();
                    if (currentProjectId) {
                        if (addDocumentToProject(currentProjectId, newDocument)) {
                            // Show success message
                            showNotification('Documento añadido exitosamente', 'success');
                            closeAddDocumentModal();
                        } else {
                            showNotification('Error al añadir el documento', 'error');
                        }
                    } else {
                        showNotification('No se pudo determinar el proyecto actual', 'error');
                    }
                });
            }

            const uploadDocForm = document.getElementById('upload-doc-form');
            if (uploadDocForm) {
                uploadDocForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    // Basic validation
                    const code = document.getElementById('upload-code').value.trim();
                    const name = document.getElementById('upload-name').value.trim();
                    const responsible = document.getElementById('upload-responsible').value.trim();
                    const project = document.getElementById('upload-project').value.trim();
                    const location = document.getElementById('upload-location').value.trim();
                    const discipline = document.getElementById('upload-discipline').value;
                    const disciplineType = document.getElementById('upload-discipline-type').value;

                    if (!code || !name || !responsible || !project || !location || !discipline || !disciplineType) {
                        showNotification('Por favor complete todos los campos requeridos y genere el código', 'error');
                        return;
                    }

                    // Get form data
                    const formData = new FormData(uploadDocForm);
                    const newDocument = {
                        name: formData.get('name'),
                        code: formData.get('code'),
                        rev: 'A', // Default revision
                        date: null, // No date by default
                        status: 'En Elaboración', // Default status
                        responsible: formData.get('responsible'),
                        discipline: getDisciplineFromCode(formData.get('code')),
                        fechaEnvio: null, // No date by default
                        fechaAprobacion: null, // No date by default
                        cost: 0, // Default cost
                        files: [
                            { type: 'pdf', link: '#', name: `${formData.get('code')}-A.pdf` }
                        ]
                    };

                    // Get current project ID (assuming we're in dashboard view)
                    const currentProjectId = getCurrentProjectId();
                    if (currentProjectId) {
                        if (addDocumentToProject(currentProjectId, newDocument)) {
                            // Show success message
                            showNotification('Documento cargado exitosamente', 'success');
                            closeUploadDocModal();
                        } else {
                            showNotification('Error al cargar el documento', 'error');
                        }
                    } else {
                        showNotification('No se pudo determinar el proyecto actual', 'error');
                    }
                });
            }
        });

        function getCSRFToken() {
            // Get CSRF token from cookie or meta tag
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                return csrfToken.value;
            }

            // Fallback: try to get from cookie
            const cookieName = 'csrftoken';
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(cookieName + '=')) {
                    return cookie.substring(cookieName.length + 1);
                }
            }

            return '';
        }

        function getCurrentProjectId() {
            // Try to get current project from active dashboard state
            const dashboardContent = document.getElementById('dashboard-content');
            if (dashboardContent && dashboardContent.dataset.projectId) {
                return dashboardContent.dataset.projectId;
            }
            
            // Fallback: return the first project ID
            return Object.keys(mockData.projects)[0];
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        window.showCostProgressChart = function() {
            const section = document.getElementById('cost-progress-section');
            if (section) {
                section.classList.remove('hidden');
                setTimeout(() => {
                    createCostProgressChart();
                }, 100);
            }
        }

        window.hideCostProgressChart = function() {
            const section = document.getElementById('cost-progress-section');
            if (section) {
                section.classList.add('hidden');
                if (costProgressChart) {
                    costProgressChart.destroy();
                    costProgressChart = null;
                }
            }
        }

        function createCostProgressChart() {
            const ctx = document.getElementById('costProgressChart');
            if (!ctx) return;

            // Generate cost progress data based on document costs and dates
            const project = mockData.projects['proj-001'];
            const documents = project.documents;
            
            // Group documents by month and calculate costs
            const monthlyData = {};
            const months = ['Jun-23', 'Jul-23', 'Aug-23', 'Sep-23', 'Oct-23', 'Nov-23', 'Dec-23', 'Jan-24'];
            
            // Initialize monthly data
            months.forEach(month => {
                monthlyData[month] = { projected: 0, real: 0 };
            });

            // Calculate projected costs (based on document dates)
            documents.forEach(doc => {
                const docDate = new Date(doc.date);
                const monthKey = docDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                const monthIndex = months.indexOf(monthKey);
                
                if (monthIndex !== -1) {
                    // Add to projected cost for this month and all subsequent months
                    for (let i = monthIndex; i < months.length; i++) {
                        monthlyData[months[i]].projected += doc.cost;
                    }
                }
            });

            // Calculate real costs (based on approval status)
            documents.forEach(doc => {
                if (doc.status === 'Aprobado' || doc.status === 'Aprobado con Comentarios') {
                    const docDate = new Date(doc.fechaAprobacion || doc.date);
                    const monthKey = docDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    const monthIndex = months.indexOf(monthKey);
                    
                    if (monthIndex !== -1) {
                        // Add to real cost for this month and all subsequent months
                        for (let i = monthIndex; i < months.length; i++) {
                            monthlyData[months[i]].real += doc.cost;
                        }
                    }
                }
            });

            const projectedData = months.map(month => monthlyData[month].projected);
            const realData = months.map(month => monthlyData[month].real);

            if (costProgressChart) {
                costProgressChart.destroy();
            }

            costProgressChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Proyectado Acumulado',
                            data: projectedData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Real Acumulado',
                            data: realData,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We have custom legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return context.dataset.label + ': $' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: Math.max(...projectedData, ...realData) * 1.1,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('en-US');
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        function showProjectCards(filterStatus) {
            dashboardHeader.querySelector('h2').textContent = "Proyectos";
            const backButton = dashboardHeader.querySelector('#back-to-projects-btn');
            if (backButton) backButton.remove();
            
            projectFilters.classList.remove('hidden');
            projectCardsContainer.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            renderProjectCards(filterStatus);
        }
        
        function showDashboardDetail(projectId) {
            const project = mockData.projects[projectId];
            dashboardHeader.querySelector('h2').textContent = project.name;
            
            if (!dashboardHeader.querySelector('#back-to-projects-btn')) {
                const backButton = document.createElement('button');
                backButton.id = 'back-to-projects-btn';
                backButton.className = "text-sm text-red-600 font-semibold flex items-center mt-2 cursor-pointer";
                backButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> Volver a Proyectos`;
                dashboardHeader.querySelector('div').appendChild(backButton);
                backButton.addEventListener('click', () => {
                    const activeFilter = projectFilters.querySelector('.filter-btn.active').dataset.status;
                    showProjectCards(activeFilter);
                });
            }

            projectFilters.classList.add('hidden');
            projectCardsContainer.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            renderDashboard(projectId);
        }
        
        // --- NOTIFICATIONS FUNCTIONALITY ---
        // State management
        let currentFilter = {
            status: 'all',
            type: 'all',
            project: 'all',
            search: ''
        };

        let currentPage = 1;
        const itemsPerPage = 10;

        // Icon mapping with improved styling
        const iconMap = {
            'check-circle': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`,
            'exclamation-triangle': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
            </svg>`,
            'inbox': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
            </svg>`,
            'clock': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`,
            'x-circle': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>`,
            'document-plus': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>`,
            'chart-bar': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>`,
            'chat-bubble-left': `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>`
        };

        // Color mapping for notification types
        const colorMap = {
            'green': 'text-green-600 bg-green-50',
            'yellow': 'text-yellow-600 bg-yellow-50',
            'blue': 'text-blue-600 bg-blue-50',
            'orange': 'text-orange-600 bg-orange-50',
            'red': 'text-red-600 bg-red-50',
            'purple': 'text-purple-600 bg-purple-50'
        };

        // Priority mapping
        const priorityMap = {
            'high': { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'Alta' },
            'medium': { color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-yellow-200', label: 'Media' },
            'low': { color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200', label: 'Baja' }
        };

        // Utility functions
        function formatNotificationTime(timestamp) {
            const now = new Date();
            const notificationTime = new Date(timestamp);
            const diffInMinutes = Math.floor((now - notificationTime) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Ahora';
            if (diffInMinutes < 60) return `Hace ${diffInMinutes} min`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `Hace ${diffInHours}h`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `Hace ${diffInDays}d`;
            
            return notificationTime.toLocaleDateString('es-ES', { 
                day: 'numeric', 
                month: 'short' 
            });
        }

        function getNotificationIcon(iconName, color) {
            const colorClasses = colorMap[color] || colorMap['blue'];
            return `<div class="flex-shrink-0 w-10 h-10 rounded-full ${colorClasses} flex items-center justify-center">
                ${iconMap[iconName] || iconMap['check-circle']}
            </div>`;
        }

        function getPriorityBadge(priority) {
            const priorityInfo = priorityMap[priority] || priorityMap['low'];
            return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${priorityInfo.bg} ${priorityInfo.color} border ${priorityInfo.border}">
                ${priorityInfo.label}
            </span>`;
        }

        function filterNotifications() {
            let filtered = [...notificationsData];
            
            // Apply search filter
            if (currentFilter.search) {
                const searchTerm = currentFilter.search.toLowerCase();
                filtered = filtered.filter(notification => 
                    notification.title.toLowerCase().includes(searchTerm) ||
                    notification.message.toLowerCase().includes(searchTerm) ||
                    notification.projectName.toLowerCase().includes(searchTerm) ||
                    (notification.documentCode && notification.documentCode.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (currentFilter.status !== 'all') {
                filtered = filtered.filter(notification => 
                    currentFilter.status === 'unread' ? !notification.read : notification.read
                );
            }
            
            // Apply type filter
            if (currentFilter.type !== 'all') {
                filtered = filtered.filter(notification => notification.type === currentFilter.type);
            }
            
            // Apply project filter
            if (currentFilter.project !== 'all') {
                filtered = filtered.filter(notification => notification.projectId === currentFilter.project);
            }
            
            return filtered;
        }

        function updateStatistics() {
            const total = notificationsData.length;
            const unread = notificationsData.filter(n => !n.read).length;
            const read = notificationsData.filter(n => n.read).length;
            
            // Count today's notifications
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayCount = notificationsData.filter(n => {
                const notificationDate = new Date(n.timestamp);
                notificationDate.setHours(0, 0, 0, 0);
                return notificationDate.getTime() === today.getTime();
            }).length;
            
            const totalNotificationsSpan = document.getElementById('total-notifications');
            const unreadNotificationsSpan = document.getElementById('unread-notifications');
            const readNotificationsSpan = document.getElementById('read-notifications');
            const todayNotificationsSpan = document.getElementById('today-notifications');
            
            if (totalNotificationsSpan) totalNotificationsSpan.textContent = total;
            if (unreadNotificationsSpan) unreadNotificationsSpan.textContent = unread;
            if (readNotificationsSpan) readNotificationsSpan.textContent = read;
            if (todayNotificationsSpan) todayNotificationsSpan.textContent = todayCount;
            
            // Update notification bell badge
            updateNotificationBadge(unread);
        }

        function updateNotificationBadge(unreadCount) {
            const notificationBadge = document.getElementById('notification-badge');
            const notificationCount = document.getElementById('notification-count');
            
            if (unreadCount > 0) {
                if (unreadCount > 9) {
                    // Show count badge for more than 9 notifications
                    if (notificationBadge) notificationBadge.classList.add('hidden');
                    if (notificationCount) {
                        notificationCount.classList.remove('hidden');
                        notificationCount.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    }
                } else {
                    // Show pulsing dot for 1-9 notifications
                    if (notificationCount) notificationCount.classList.add('hidden');
                    if (notificationBadge) notificationBadge.classList.remove('hidden');
                }
            } else {
                // Hide both badges when no unread notifications
                if (notificationBadge) notificationBadge.classList.add('hidden');
                if (notificationCount) notificationCount.classList.add('hidden');
            }
        }

        function renderNotificationDropdown() {
            const notificationList = document.getElementById('notification-list');
            if (!notificationList) return;

            // Get the first 3 unread notifications for the dropdown
            const unreadNotifications = notificationsData.filter(n => !n.read).slice(0, 3);
            
            if (unreadNotifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <p class="text-sm">No hay notificaciones nuevas</p>
                    </div>
                `;
                return;
            }

            notificationList.innerHTML = unreadNotifications.map(notification => {
                const icon = getNotificationIcon(notification.icon, notification.color);
                const timeAgo = formatNotificationTime(notification.timestamp);
                
                return `
                    <div class="notification-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer bg-blue-50" data-notification-id="${notification.id}">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0 mt-1">
                                ${icon}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-semibold text-gray-900 truncate flex-1 min-w-0">${notification.title}</p>
                                    <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${timeAgo}</span>
                                </div>
                                <p class="text-sm text-gray-600 mt-1 break-words">${notification.message}</p>
                                <div class="flex items-center mt-2 flex-wrap gap-1">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 truncate max-w-full">${notification.projectName}</span>
                                    ${notification.documentCode ? `
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 truncate max-w-full">${notification.documentCode}</span>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listeners to dropdown notification items
            document.querySelectorAll('#notification-list .notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const notificationId = parseInt(e.currentTarget.dataset.notificationId);
                    markNotificationAsRead(notificationId);
                    // Close dropdown after clicking
                    const dropdown = document.getElementById('notification-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                });
            });
        }

        function toggleNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            if (!dropdown) return;

            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                renderNotificationDropdown();
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function closeNotificationDropdown() {
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
        }

        function renderNotificationItem(notification) {
            const priorityBadge = getPriorityBadge(notification.priority);
            const icon = getNotificationIcon(notification.icon, notification.color);
            const timeAgo = formatNotificationTime(notification.timestamp);
            
            return `
                <div class="notification-item p-6 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-all duration-200 ${notification.read ? 'opacity-75' : 'bg-gradient-to-r from-blue-50 to-transparent border-l-4 border-l-blue-500'} ${!notification.read ? 'shadow-sm' : ''}" 
                     data-notification-id="${notification.id}">
                  <div class="flex items-start space-x-4">
                    ${icon}
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                          <h4 class="text-sm font-semibold text-gray-900 mb-1 leading-tight">${notification.title}</h4>
                          <p class="text-sm text-gray-600 mb-3 leading-relaxed">${notification.message}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2 ml-4">
                          <span class="text-xs text-gray-500 font-medium">${timeAgo}</span>
                          ${!notification.read ? '<div class="w-2 h-2 bg-red-500 rounded-full"></div>' : ''}
                        </div>
                      </div>
                      
                      <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            ${notification.projectName}
                          </span>
                          ${notification.documentCode ? `
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 font-mono">
                              ${notification.documentCode}
                            </span>
                          ` : ''}
                          ${priorityBadge}
                        </div>
                        
                        <div class="flex items-center space-x-2">
                          ${!notification.read ? `
                            <button class="mark-read-btn text-xs text-gray-500 hover:text-blue-600 font-medium transition-colors" 
                                    data-notification-id="${notification.id}">
                              Marcar como leída
                            </button>
                          ` : ''}
                          <button class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
            `;
        }

        function renderNotifications() {
            const filteredNotifications = filterNotifications();
            const totalPages = Math.ceil(filteredNotifications.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedNotifications = filteredNotifications.slice(startIndex, endIndex);
            
            // Update statistics
            updateStatistics();
            
            // Update showing count
            const showingCountSpan = document.getElementById('showing-count');
            const totalCountSpan = document.getElementById('total-count');
            if (showingCountSpan) showingCountSpan.textContent = paginatedNotifications.length;
            if (totalCountSpan) totalCountSpan.textContent = filteredNotifications.length;
            
            // Render notifications
            const notificationsContainer = document.getElementById('notifications-container');
            const noNotificationsDiv = document.getElementById('no-notifications');
            
            if (notificationsContainer) {
                if (paginatedNotifications.length === 0) {
                    notificationsContainer.innerHTML = '';
                    if (noNotificationsDiv) noNotificationsDiv.classList.remove('hidden');
                } else {
                    if (noNotificationsDiv) noNotificationsDiv.classList.add('hidden');
                    notificationsContainer.innerHTML = paginatedNotifications.map(renderNotificationItem).join('');
                    
                    // Add event listeners
                    addNotificationEventListeners();
                }
            }
            
            // Update pagination
            updatePagination(totalPages);
        }

        function updatePagination(totalPages) {
            const pageNumbersDiv = document.getElementById('page-numbers');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            if (!pageNumbersDiv || !prevPageBtn || !nextPageBtn) return;
            
            // Update prev/next buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            // Clear existing page numbers
            pageNumbersDiv.innerHTML = '';
            
            // Generate page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-2 text-sm font-medium rounded-md transition-colors ${
                    i === currentPage 
                        ? 'bg-red-600 text-white' 
                        : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-50'
                }`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    renderNotifications();
                });
                pageNumbersDiv.appendChild(pageBtn);
            }
        }

        function addNotificationEventListeners() {
            // Mark as read functionality
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const notificationId = parseInt(e.target.dataset.notificationId);
                    markNotificationAsRead(notificationId);
                });
            });
            
            // Notification click functionality
            document.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.mark-read-btn') && !e.target.closest('button')) {
                        const notificationId = parseInt(e.currentTarget.dataset.notificationId);
                        markNotificationAsRead(notificationId);
                        // Here you could add navigation to the specific document/transmittal
                        console.log('Navigate to notification:', notificationId);
                    }
                });
            });
        }

        function markNotificationAsRead(notificationId) {
            const notification = notificationsData.find(n => n.id === notificationId);
            if (notification && !notification.read) {
                notification.read = true;
                renderNotifications();
                // Update dropdown if it's open
                const dropdown = document.getElementById('notification-dropdown');
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    renderNotificationDropdown();
                }
            }
        }

        function markAllNotificationsAsRead() {
            notificationsData.forEach(notification => {
                notification.read = true;
            });
            renderNotifications();
            // Update dropdown if it's open
            const dropdown = document.getElementById('notification-dropdown');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                renderNotificationDropdown();
            }
        }

        function refreshNotifications() {
            // In a real app, this would fetch from the server
            console.log('Refreshing notifications...');
            renderNotifications();
        }

        function initializeNotificationEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('search-notifications');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    currentFilter.search = e.target.value;
                    currentPage = 1;
                    renderNotifications();
                });
            }
            
            // Filter functionality
            const statusFilter = document.getElementById('status-filter');
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    currentFilter.status = e.target.value;
                    currentPage = 1;
                    renderNotifications();
                });
            }
            
            const typeFilter = document.getElementById('type-filter');
            if (typeFilter) {
                typeFilter.addEventListener('change', (e) => {
                    currentFilter.type = e.target.value;
                    currentPage = 1;
                    renderNotifications();
                });
            }
            
            const projectFilter = document.getElementById('project-filter');
            if (projectFilter) {
                projectFilter.addEventListener('change', (e) => {
                    currentFilter.project = e.target.value;
                    currentPage = 1;
                    renderNotifications();
                });
            }
            
            // Action buttons
            const markAllReadBtn = document.getElementById('mark-all-read-btn');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
            }
            
            const refreshBtn = document.getElementById('refresh-notifications-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshNotifications);
            }
            
            // Pagination
            const prevPageBtn = document.getElementById('prev-page');
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderNotifications();
                    }
                });
            }
            
            const nextPageBtn = document.getElementById('next-page');
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const filteredNotifications = filterNotifications();
                    const totalPages = Math.ceil(filteredNotifications.length / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderNotifications();
                    }
                });
            }
        }

        // --- APP LOGIC & EVENT LISTENERS ---
        function switchView(viewId) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[href="#${viewId.replace('-view', '')}"]`).classList.add('active');
            
            if (viewId === 'dashboard-view') {
                 const activeFilter = projectFilters.querySelector('.filter-btn.active')?.dataset.status || 'En Ejecución';
                 showProjectCards(activeFilter);
            } else if (viewId === 'repository-view') {
                 renderRepository(Object.keys(mockData.projects)[0]);
            } else if (viewId === 'transmittals-view') {
                renderTransmittalList();
            } else if (viewId === 'notifications-view') {
                initializeNotificationEventListeners();
                renderNotifications();
            }
        }

        mainNav.addEventListener('click', (e) => {
            if (e.target.closest('.nav-link')) {
                e.preventDefault();
                const viewName = e.target.closest('.nav-link').hash.substring(1);
                switchView(`${viewName}-view`);
            }
        });

        projectFilters.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                const status = e.target.dataset.status;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'halli-red-bg', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-600');
                });
                e.target.classList.add('active', 'halli-red-bg', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-600');
                renderProjectCards(status);
            }
        });

        function closeModalElement(modal) {
            if (modalBackdrop) {
                modalBackdrop.classList.add('hidden');
            }
            modal.classList.add('hidden');
        }

        createTransmittalBtn.addEventListener('click', () => {
            transmittalModal.querySelector('.bg-white').innerHTML = `<div class="p-6 border-b"><h3 class="text-xl font-semibold">Crear Nuevo Transmittal</h3></div><form class="p-6 space-y-4"><div><label class="block text-sm font-medium text-gray-700">Destinatario</label><select class="mt-1 block w-full p-2 border rounded-md"><option>Cliente A</option><option>Subcontratista B</option></select></div><div><label class="block text-sm font-medium text-gray-700">Propósito</label><select class="mt-1 block w-full p-2 border rounded-md"><option>Para Revisión y Comentarios</option><option>Para Aprobación</option></select></div><div><label class="block text-sm font-medium text-gray-700">Adjuntar Documentos del Repositorio</label><div class="mt-1 border rounded-md h-48 overflow-y-auto p-2 space-y-2 bg-gray-50"><div class="flex items-center"><input type="checkbox" class="mr-2" checked><span>PA-PIP-ISO-088 - Rev C (AI)</span></div><div class="flex items-center text-gray-400"><input type="checkbox" class="mr-2" disabled><span class="line-through">PA-CIV-LYT-005 - Rev B (RI)</span><svg title="No Aprobado Internamente" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.21 2.864-1.21 3.5 0l7.25 13.81c.594 1.128-.214 2.591-1.514 2.591H2.514C1.214 19.5.406 18.037 1 16.91L8.257 3.099zM10 12a1 1 0 100-2 1 1 0 000 2zm0-5a1 1 0 011 1v2a1 1 0 11-2 0V8a1 1 0 011-1z" clip-rule="evenodd" /></svg></div></div></div></form><div class="p-4 bg-gray-50 flex justify-end space-x-2"><button class="close-modal-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">Cancelar</button><button class="px-4 py-2 text-sm font-medium text-white halli-red-bg rounded-md hover:opacity-90">Generar y Enviar</button></div>`;
            openModal(transmittalModal);
        });
        
        uploadDocBtn.addEventListener('click', () => openModal(uploadDocModal));
        
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('close-modal-btn')) {
                closeModalElement(transmittalModal);
                closeModalElement(uploadDocModal);
                closeModalElement(document.getElementById('document-details-modal'));
            }
            
            // Close modal when clicking on backdrop
            if (e.target.id === 'modal-backdrop') {
                closeModalElement(transmittalModal);
                closeModalElement(uploadDocModal);
                closeModalElement(document.getElementById('document-details-modal'));
                closeModalElement(document.getElementById('add-document-modal'));
                closeModalElement(document.getElementById('recent-activity-modal'));
                closeModalElement(document.getElementById('docStatusModal'));
                closeModalElement(document.getElementById('costModal'));
                closeModalElement(document.getElementById('disciplineModal'));
                closeModalElement(document.getElementById('teamModal'));
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            renderReports();
            renderSettings();
            switchView('dashboard-view');
            
            // Initialize notification bell click handler
            const notificationBell = document.getElementById('notification-bell');
            if (notificationBell) {
                notificationBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNotificationDropdown();
                });
            }

            // Handle dropdown actions
            const markAllReadDropdown = document.getElementById('mark-all-read-dropdown');
            if (markAllReadDropdown) {
                markAllReadDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                    markAllNotificationsAsRead();
                    closeNotificationDropdown();
                });
            }

            const viewAllNotifications = document.getElementById('view-all-notifications');
            if (viewAllNotifications) {
                viewAllNotifications.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeNotificationDropdown();
                    switchView('notifications-view');
                });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('notification-dropdown');
                const bell = document.getElementById('notification-bell');
                
                if (dropdown && !dropdown.contains(e.target) && !bell.contains(e.target)) {
                    closeNotificationDropdown();
                }
            });
            
            // Initialize notification badge on page load
            updateNotificationBadge(notificationsData.filter(n => !n.read).length);

            // Initialize user profile modal
            const userProfileTrigger = document.getElementById('user-profile-trigger');
            if (userProfileTrigger) {
                userProfileTrigger.addEventListener('click', () => {
                    openModal('user-profile-modal');
                });
            }
        });
    </script>

    <!-- Global Status Legend -->
    <div id="global-status-legend" class="fixed bottom-4 left-4 z-10">
        <div class="bg-white rounded-lg shadow-lg p-4 max-w-sm">
            <h4 class="text-sm font-semibold halli-dark-text mb-2">Leyenda de Estados</h4>
            <div class="grid grid-cols-1 gap-2 text-xs">
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-aprobado text-xs">APR</span>
                    <span class="halli-medium-text">Aprobado</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-aprobado-comentarios text-xs">ACC</span>
                    <span class="halli-medium-text">Aprobado con Com.</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-para-aprobacion text-xs">PA</span>
                    <span class="halli-medium-text">Para Aprobación</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-para-revision-cliente text-xs">PRC</span>
                    <span class="halli-medium-text">Para Rev. Cliente</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag bg-blue-100 text-blue-800 text-xs">AI</span>
                    <span class="halli-medium-text">Aprob. Internamente</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-revision-interna text-xs">RI</span>
                    <span class="halli-medium-text">Rev. Interna</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="status-tag status-rechazado text-xs">REC</span>
                    <span class="halli-medium-text">Rechazado</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Modals -->
    <div id="docStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold halli-dark-text">Estado de Documentos</h3>
                    <button onclick="closeModalElement(document.getElementById('docStatusModal'))" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <div class="text-center">
                        <p id="docStatusProgress" class="text-3xl font-bold text-green-600">85%</p>
                        <p class="text-sm text-gray-500">Progreso General</p>
                    </div>
                </div>
                <div class="space-y-3" id="docStatusContent">
                    <!-- Document status content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Control Modal -->
    <div id="costModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-4 mx-auto p-5 border max-w-6xl shadow-2xl rounded-xl bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                            <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                            Control de Costos del Proyecto
                        </h3>
                        <p class="text-gray-600 mt-1">Análisis detallado de costos por disciplina</p>
                    </div>
                    <button onclick="closeModalElement(document.getElementById('costModal'))" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Project Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Proyectado</p>
                                <p id="totalProjectedCost" class="text-2xl font-bold">$0</p>
                            </div>
                            <svg class="w-8 h-8 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-green-500 to-green-600 p-4 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Total Ejecutado</p>
                                <p id="totalExecutedCost" class="text-2xl font-bold">$0</p>
                            </div>
                            <svg class="w-8 h-8 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-4 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="purple-100 text-sm">Varianza Total</p>
                                <p id="totalVariance" class="text-2xl font-bold">$0</p>
                                <p id="totalVariancePercent" class="text-sm opacity-90">0%</p>
                            </div>
                            <svg class="w-8 h-8 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 p-4 rounded-lg text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-indigo-100 text-sm">CPI Global</p>
                                <p id="overallCPI" class="text-2xl font-bold">0.00</p>
                            </div>
                            <svg class="w-8 h-8 text-indigo-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Discipline Cost Breakdown -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Costos por Disciplina
                    </h4>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="disciplineCostContainer">
                        <!-- Discipline cost cards will be populated here -->
                            </div>
                        </div>

                <!-- Información Detallada de Costos por Disciplina -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Información Detallada de Costos por Disciplina
                    </h4>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Procesos -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Procesos</h5>
                                </div>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">85% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$25,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$21,250</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$3,750</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">12/14</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 85%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Mecánica -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Mecánica</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">75% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$20,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$15,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$5,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">9/12</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Civil -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Civil</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">90% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$15,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$13,500</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$1,500</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">18/20</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 90%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Tubería -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Tubería</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">70% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$12,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$8,400</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$3,600</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">14/20</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 70%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Instrumentación -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Instrumentación</h5>
                                </div>
                                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">60% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$10,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$6,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$4,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">6/10</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: 60%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Eléctrica -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-pink-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Eléctrica</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">80% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$8,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$6,400</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$1,600</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">8/10</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 80%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Comunicaciones -->
                        <div class="bg-white p-4 rounded-lg border border-red-200 bg-red-50">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-teal-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Comunicaciones</h5>
                                </div>
                                <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">40% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$5,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-orange-600">$2,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-orange-600">-$3,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">2/5</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-red-500 h-2 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <div class="mt-2 text-xs text-red-700 bg-red-100 p-2 rounded">
                                ⚠️ Requiere atención inmediata
                            </div>
                        </div>

                        <!-- Skid -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-cyan-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Skid</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">95% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$6,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$5,700</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$300</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">19/20</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 95%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Protección Catódica -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Protección Catódica</h5>
                                </div>
                                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">65% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$3,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$1,950</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-green-600">-$1,050</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">13/20</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: 65%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Gestión -->
                        <div class="bg-white p-4 rounded-lg border border-gray-200">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                                    <h5 class="font-semibold text-gray-800">Gestión</h5>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">100% completado</span>
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Proyectado:</span>
                                    <span class="font-medium">$2,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Ejecutado:</span>
                                    <span class="font-medium text-green-600">$2,000</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Variación:</span>
                                    <span class="font-medium text-gray-600">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documentos:</span>
                                    <span class="font-medium">25/25</span>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen por Categorías -->
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h6 class="font-semibold text-green-800 mb-2">Disciplinas Excelentes (≥80%)</h6>
                            <p class="text-sm text-green-700">Procesos, Civil, Eléctrica, Skid, Gestión</p>
                            <p class="text-lg font-bold text-green-800 mt-2">5 disciplinas</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h6 class="font-semibold text-yellow-800 mb-2">Requieren Atención (60-79%)</h6>
                            <p class="text-sm text-yellow-700">Mecánica, Tubería, Instrumentación, Protección Catódica</p>
                            <p class="text-lg font-bold text-yellow-800 mt-2">4 disciplinas</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h6 class="font-semibold text-red-800 mb-2">Críticas (≤50%)</h6>
                            <p class="text-sm text-red-700">Comunicaciones</p>
                            <p class="text-lg font-bold text-red-800 mt-2">1 disciplina</p>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button onclick="closeModalElement(document.getElementById('costModal'))" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Cerrar
                    </button>
                    <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Exportar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="disciplineModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold halli-dark-text">Avance por Disciplina</h3>
                    <button onclick="closeModalElement(document.getElementById('disciplineModal'))" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-y-3" id="disciplineModalContent">
                    <!-- Discipline progress content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <div id="teamModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold halli-dark-text">Equipo del Proyecto</h3>
                    <button onclick="closeModalElement(document.getElementById('teamModal'))" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="space-y-3" id="teamModalContent">
                    <!-- Team content will be populated here -->
                </div>
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <button class="w-full flex items-center justify-center space-x-2 p-3 text-sm text-gray-500 hover:text-gray-700 hover:bg-gray-50 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        <span>Agregar miembro</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>


